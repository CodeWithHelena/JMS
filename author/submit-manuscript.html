<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Create Submission</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Toastr CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Quill Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="/assets/css/header_sidebar.css">
    <style>
        .submission-form {
            background: var(--sidebar-bg);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .form-title {
            color: var(--text-color);
            font-weight: 700;
            margin-bottom: 5px;
        }

        .form-subtitle {
            color: var(--text-light);
            font-size: 16px;
            margin-bottom: 30px;
        }

        .form-label {
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 8px;
        }

        .form-control,
        .form-select {
            border-radius: 8px;
            border: 1px solid var(--border-color);
            padding: 12px 15px;
            background-color: var(--sidebar-bg);
            color: var(--text-color);
            transition: var(--transition);
        }

        .form-control:focus,
        .form-select:focus {
            box-shadow: 0 0 0 3px rgba(204, 85, 0, 0.2);
            border-color: var(--secondary-color2);
        }

        /* Authors Section */
        .author-row {
            margin-bottom: 15px;
            align-items: start;
        }

        .add-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            height: 100%;
            transition: var(--transition);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 500;
            white-space: nowrap;
            min-width: 80px;
             margin-top: 2px
        }

        .add-btn {
            background-color: var(--success-dark);
            color: white;
        }

        .add-btn:hover {
            background-color: var(--success-dark);
            color: #fff;
            transform: translateY(-1px);
            opacity: 0.8;
        }

        .btn-remove {
            background: none;
            border: none;
            color: var(--danger-dark)
        }

        .author-meta {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .author-affiliations {
            margin-top: 6px;
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .affiliation-badge {
            display: inline-block;
            margin-right: 6px;
            margin-top: 4px;
            padding: 4px 8px;
            border-radius: 999px;
            background: var(--body-bg);
            border: 1px solid var(--border-color);
            font-size: 0.8rem;
            color: var(--text-color);
        }

        .file-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            transition: var(--transition);
            cursor: pointer;
            background-color: var(--body-bg);
        }

        .file-upload-area:hover,
        .file-upload-area.dragover {
            border-color: var(--secondary-color2);
            background-color: var(--lite-secondary6);
        }

        .file-upload-icon {
            font-size: 48px;
            color: var(--text-light);
            margin-bottom: 15px;
        }

        .file-upload-text {
            color: var(--text-color);
            margin-bottom: 10px;
            font-weight: 500;
        }

        .file-upload-subtext {
            color: var(--text-light);
            font-size: 14px;
        }

        .file-types {
            display: inline-block;
            background-color: var(--danger-dark);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 5px;
        }

        .file-preview {
            margin-top: 20px;
            display: none;
        }

        .file-preview-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background-color: var(--body-bg);
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
        }

        .file-preview-name {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-color);
        }

        .file-preview-remove {
            color: var(--danger-dark);
            cursor: pointer;
            background: none;
            border: none;
            padding: 5px;
        }

        .error-message {
            color: var(--danger-dark);
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }

        /* Keywords styling */
        .keywords-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }

        .keyword-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 999px;
            background: var(--body-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            font-size: 0.95rem;
        }

        .keyword-remove {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--danger-dark);
            padding: 0;
            display: inline-flex;
            align-items: center;
        }

        /* Quill Editor Styling */
        .ql-toolbar.ql-snow {
            border-color: var(--border-color);
            background-color: var(--body-bg);
        }

        .ql-container.ql-snow {
            border-color: var(--border-color);
            background-color: var(--sidebar-bg);
            color: var(--text-color);
            min-height: 200px;
        }

        .ql-editor {
            color: var(--text-color);
        }

        .ql-editor.ql-blank::before {
            color: var(--text-light);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .submission-form {
                padding: 20px;
            }

            .author-row .col-md-4,
            .author-row .col-md-3,
            .author-row .col-md-1 {
                margin-bottom: 10px;
            }
        }

        @media (max-width: 576px) {
            .submit-btn {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <!-- Sidebar Included-->
        <div id="sidebar-placeholder"></div>
        <div class="main-content-wrapper">
            <!-- Header Included-->
            <div id="header-placeholder"></div>
            <main class="main-content">
                <div class="container page-title">
                    <div>
                        <h1>Submit Manuscript</h1>
                        <p>Create a new submission</p>
                    </div>
                </div>
                <div class="container my-4">
                    <div class="row justify-content-center">
                        <div class="col-lg-12">
                            <form id="submissionForm" class="submission-form">
                                <!-- Scope Selection -->
                                <div class="mb-4">
                                    <label class="form-label">Select a scope to submit</label>
                                    <div class="custom-select" id="scopeSelect">
                                        <div class="select-header">
                                            <span class="select-placeholder">Select scope</span>
                                            <i class="fas fa-chevron-down select-arrow"></i>
                                        </div>
                                        <div class="select-dropdown">
                                            <div class="select-search-container">
                                                <input type="text" placeholder="Search scopes..." id="scopeSearch">
                                                <button type="button" class="search-clear">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                            <div class="select-options" id="scopeOptions">
                                                <!-- Options will be populated by JavaScript -->
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Hidden input stores selected scope id (or fallback name) -->
                                    <input type="hidden" id="selectedScope" name="scopeId">
                                </div>

                                <!-- Manuscript Title -->
                                <div class="mb-4">
                                    <label for="manuscriptTitle" class="form-label">Title of Manuscript</label>
                                    <input type="text" class="form-control" id="manuscriptTitle" name="title" placeholder="Enter the title of your manuscript">
                                </div>

                                <!-- Abstract -->
                                <div class="mb-4">
                                    <label for="abstractEditor" class="form-label">Abstract of Manuscript</label>
                                    <div id="abstractEditor"></div>
                                    <input type="hidden" id="abstractContent" name="abstract">
                                </div>

                                <!-- Keywords -->
                                <div class="mb-4">
                                    <label class="form-label">Add Keywords</label>
                                    <div id="keywords-container">
                                        <div id="addedKeywordsList" class="keywords-list"></div>
                                        <div class="d-flex gap-2">
                                            <input type="text" id="keywordInput" class="form-control" placeholder="Enter keyword(s) e.g. computer science, agriculture">
                                            <button type="button" id="addKeywordBtn" class="btn add-btn">
                                                <i class="fas fa-plus"></i> Add Keyword
                                            </button>
                                        </div>
                                        <div class="error-message" id="keywordError">Please enter a valid keyword</div>
                                        <input type="hidden" id="keywordsHidden" name="keywords">
                                    </div>
                                </div>

                                <!-- Authors -->
                                <div class="mb-4">
                                    <label class="form-label">Co-Authors</label>
                                    <div id="authors-container"></div>
                                </div>

                                <!-- File Upload -->
                                <div class="mb-4">
                                    <label class="form-label">Upload Manuscript <span class="file-types">.PDF, .DOCX</span></label>
                                    <div class="file-upload-area" id="fileUploadArea">
                                        <div class="file-upload-icon">
                                            <i class="fas fa-cloud-upload-alt"></i>
                                        </div>
                                        <div class="file-upload-text">Drag & Drop your file here</div>
                                        <div class="file-upload-subtext">or click to browse</div>
                                        <input type="file" id="manuscriptFile" name="file" accept=".pdf,.docx" style="display: none;">
                                    </div>
                                    <div class="error-message" id="fileError">
                                        <i class="fas fa-times-circle"></i> Only .PDF or .DOCX files are allowed.
                                    </div>
                                    <div class="file-preview" id="filePreview">
                                        <!-- File preview will be added here -->
                                    </div>
                                </div>

                                <!-- Submit Button -->
                                <div class="d-flex justify-content-end">
                                    <button type="submit" id="submitBtn" class=" btn-brand">Submit</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        window.SIDEBAR_MODULE = 'author';
        window.SIDEBAR_ACTIVE_ID = 'create-submission';
    </script>
    <script src="/assets/js/layout.js"></script>
    <!-- Quill JS -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery (required for toastr) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Toastr JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

    <!-- Main JS (module so we can import BASE_URL/token from utility.js if you use it) -->
    <script type="module">
        import { BASE_URL, token } from '/assets/js/utility.js';

        document.addEventListener('DOMContentLoaded', function () {
            // -------------------------------
            // Reusable: fetch scopes
            // -------------------------------
            async function getScopes() {
                try {
                    const url = new URL(`${BASE_URL}/scope/shallow`)
                    const res = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                            ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                        }
                    });

                    if (!res.ok) {
                        console.error('Failed to fetch scopes', res.status, res.statusText);
                        return [];
                    }

                    const payload = await res.json();
                    if (Array.isArray(payload)) return payload;
                    if (Array.isArray(payload.data)) return payload.data;
                    if (Array.isArray(payload.scopes)) return payload.scopes;
                    const arr = Object.values(payload).find(v => Array.isArray(v));
                    if (Array.isArray(arr)) return arr;
                    return [];
                } catch (err) {
                    console.error('Error fetching scopes:', err);
                    return [];
                }
            }
            window.getScopes = getScopes;

            // -------------------------------
            // Quill initialization
            // -------------------------------
            const quill = new Quill('#abstractEditor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                        ['clean']
                    ]
                }
            });
            quill.on('text-change', function () {
                document.getElementById('abstractContent').value = quill.root.innerHTML;
            });

            // -------------------------------
            // Custom select logic (scopes)
            // -------------------------------
            const scopeSelect = document.getElementById('scopeSelect');
            const selectHeader = scopeSelect.querySelector('.select-header');
            const selectDropdown = scopeSelect.querySelector('.select-dropdown');
            const selectArrow = scopeSelect.querySelector('.select-arrow');
            const scopeSearch = document.getElementById('scopeSearch');
            const searchClear = scopeSelect.querySelector('.search-clear');
            const scopeOptions = document.getElementById('scopeOptions');
            const selectedScope = document.getElementById('selectedScope');

            function getScopeDisplayName(item) {
                if (typeof item === 'string') return item;
                if (!item) return '';
                return item.title || item.name || item.scopeName || item.shortTitle || item._id || JSON.stringify(item);
            }

            function getScopeId(item) {
                if (!item) return '';
                if (typeof item === 'string') return item; // fallback: use name as id
                return item._id || item.id || getScopeDisplayName(item);
            }

            function populateScopeOptions(filter = '') {
                scopeOptions.innerHTML = '';
                const filtered = scopesCache.filter(j =>
                    getScopeDisplayName(j).toLowerCase().includes(filter.toLowerCase())
                );

                if (filtered.length === 0) {
                    const noResults = document.createElement('div');
                    noResults.className = 'select-option';
                    noResults.textContent = 'No scopes found';
                    noResults.style.color = 'var(--text-light)';
                    noResults.style.cursor = 'default';
                    scopeOptions.appendChild(noResults);
                    return;
                }

                filtered.forEach(j => {
                    const option = document.createElement('div');
                    option.className = 'select-option';
                    const name = getScopeDisplayName(j);
                    const id = getScopeId(j);
                    option.textContent = name;
                    option.dataset.jid = id;
                    option.addEventListener('click', function () {
                        selectHeader.querySelector('.select-placeholder').textContent = name;
                        selectedScope.value = id; // store id (if present) else fallback name
                        selectHeader.classList.remove('open');
                        selectDropdown.style.display = 'none';
                        selectArrow.classList.remove('open');
                    });
                    scopeOptions.appendChild(option);
                });
            }

            let scopesCache = [];

            (async function loadScopesAndPopulate() {
                const remote = await getScopes();
                if (remote && remote.length) scopesCache = remote;
                populateScopeOptions();
            })();

            selectHeader.addEventListener('click', function () {
                const isOpen = selectHeader.classList.contains('open');

                if (isOpen) {
                    selectHeader.classList.remove('open');
                    selectDropdown.style.display = 'none';
                    selectArrow.classList.remove('open');
                } else {
                    selectHeader.classList.add('open');
                    selectDropdown.style.display = 'block';
                    selectArrow.classList.add('open');
                    scopeSearch.focus();
                }
            });

            scopeSearch.addEventListener('input', function () {
                populateScopeOptions(this.value);
            });

            searchClear.addEventListener('click', function () {
                scopeSearch.value = '';
                populateScopeOptions();
                scopeSearch.focus();
            });

            document.addEventListener('click', function (e) {
                if (!scopeSelect.contains(e.target)) {
                    selectHeader.classList.remove('open');
                    selectDropdown.style.display = 'none';
                    selectArrow.classList.remove('open');
                }
            });

            // -------------------------------
            // AUTHORS: add/remove with optional affiliations
            // -------------------------------
            const authorsContainer = document.getElementById("authors-container");

            
            // 2) authorInputArea (the input rows)
            authorsContainer.innerHTML = `
                <div id="addedAuthorsList" class="mb-3"></div>
                <div id="authorInputArea"></div>
            `;

            const addedAuthorsList = document.getElementById('addedAuthorsList');
            const authorInputArea = document.getElementById('authorInputArea');

            let authorsAdded = []; // {id, name, email, affiliation: []}

            function isValidEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }

            function renderAddedAuthors() {
                // Shows the added authors at the top with an X to remove
                addedAuthorsList.innerHTML = '';
                if (authorsAdded.length === 0) {
                    // no authors - show nothing
                    return;
                }

                authorsAdded.forEach(a => {
                    const item = document.createElement('div');
                    item.className = 'd-flex align-items-start justify-content-between p-2 mb-2';
                    item.style.background = 'var(--body-bg)';
                    item.style.border = '1px solid var(--border-color)';
                    item.style.borderRadius = '8px';

                    // Build affiliation badges if present
                    let affHtml = '';
                    if (Array.isArray(a.affiliation) && a.affiliation.length) {
                        affHtml = `<div class="author-affiliations">`;
                        a.affiliation.forEach(aff => {
                            affHtml += `<span class="affiliation-badge">${escapeHtml(aff)}</span>`;
                        });
                        affHtml += `</div>`;
                    }

                    item.innerHTML = `
                        <div>
                            <strong>${escapeHtml(a.name)}</strong>
                            <div class="author-meta">${escapeHtml(a.email)}</div>
                            ${affHtml}
                        </div>
                        <div>
                            <button type="button" class="btn btn-remove" data-id="${a.id}" title="Remove author">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    const btn = item.querySelector('button');
                    btn.addEventListener('click', function () {
                        const id = this.dataset.id;
                        authorsAdded = authorsAdded.filter(x => String(x.id) !== String(id));
                        renderAddedAuthors();
                    });

                    addedAuthorsList.appendChild(item);
                });
            }

            // simple HTML escape helper
            function escapeHtml(str) {
                if (!str) return '';
                return str.replace(/[&<>\"'`=\/]/g, function (s) {
                    return ({
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        '"': '&quot;',
                        "'": '&#39;',
                        '/': '&#x2F;',
                        '`': '&#x60;',
                        '=': '&#x3D;'
                    })[s];
                });
            }

            function createAuthorRow() {
                const row = document.createElement("div");
                row.className = "row g-2 align-items-start mb-3 author-row";

                // layout: name (col-md-4), email (col-md-4), affiliation (col-md-3), button (col-md-1)
                row.innerHTML = `
                    <div class="col-md-4">
                        <input type="text" class="form-control fullName" placeholder="Full name" />
                        <div class="error-message error-fullname">Full name is required</div>
                    </div>
                    <div class="col-md-4">
                        <input type="email" class="form-control email" placeholder="Email" />
                        <div class="error-message error-email">Valid email is required</div>
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control affiliation" placeholder="Affiliation(s) (optional) e.g. Univ A, Univ B" />
                        <div class="error-message error-affiliation" style="display:none;">Affiliation error</div>
                    </div>
                    <div class="col-md-1 d-grid">
                        <button type="button" class="btn add-btn w-100" style="height: 45px;" title="Add Author">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                `;

                authorInputArea.appendChild(row);

                const addBtn = row.querySelector(".add-btn");
                addBtn.addEventListener("click", () => handleAdd(row));
                // allow pressing Enter in any input inside the row to trigger add
                row.querySelectorAll('input').forEach(inp => {
                    inp.addEventListener('keydown', function (e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            handleAdd(row);
                        }
                    });
                });
            }

            function handleAdd(row) {
                const fullNameInput = row.querySelector(".fullName");
                const emailInput = row.querySelector(".email");
                const affiliationInput = row.querySelector(".affiliation");
                const errorFullname = row.querySelector(".error-fullname");
                const errorEmail = row.querySelector(".error-email");
                const errorAff = row.querySelector(".error-affiliation");

                // hide previous inline errors
                errorFullname.style.display = "none";
                errorEmail.style.display = "none";
                if (errorAff) errorAff.style.display = "none";

                let hasError = false;

                if (fullNameInput.value.trim() === "") {
                    errorFullname.textContent = "Full name is required";
                    errorFullname.style.display = "block";
                    hasError = true;
                }

                if (emailInput.value.trim() === "") {
                    errorEmail.textContent = "Email is required";
                    errorEmail.style.display = "block";
                    hasError = true;
                } else if (!isValidEmail(emailInput.value.trim())) {
                    errorEmail.textContent = "Please enter a valid email address";
                    errorEmail.style.display = "block";
                    hasError = true;
                } else if (authorsAdded.some(a => a.email.toLowerCase() === emailInput.value.trim().toLowerCase())) {
                    errorEmail.textContent = "This author is already added";
                    errorEmail.style.display = "block";
                    hasError = true;
                }

                if (hasError) {
                    // Per your requirement: do not use toastr for add/remove. Only inline errors for the inputs.
                    return;
                }

                // Parse affiliations (comma-separated). If empty -> []
                const rawAff = affiliationInput.value || '';
                const affArr = rawAff.split(',').map(p => p.trim()).filter(Boolean);

                const authorObj = {
                    id: Date.now() + Math.random().toString(36).slice(2, 8),
                    name: fullNameInput.value.trim(),
                    email: emailInput.value.trim(),
                    affiliation: affArr
                };
                authorsAdded.unshift(authorObj); // add to start so newest appears on top
                renderAddedAuthors();

                // remove the current row from DOM and create a fresh one
                row.remove();
                createAuthorRow();
            }

            // start with one empty row
            createAuthorRow();

            // -------------------------------
            // KEYWORDS: add/remove + comma support
            // -------------------------------
            const addedKeywordsList = document.getElementById('addedKeywordsList');
            const keywordInput = document.getElementById('keywordInput');
            const addKeywordBtn = document.getElementById('addKeywordBtn');
            const keywordError = document.getElementById('keywordError');
            const keywordsHidden = document.getElementById('keywordsHidden');

            let keywordsAdded = []; // array of strings

            function renderAddedKeywords() {
                addedKeywordsList.innerHTML = '';
                if (keywordsAdded.length === 0) return;
                keywordsAdded.forEach((k, idx) => {
                    const chip = document.createElement('div');
                    chip.className = 'keyword-chip';
                    chip.innerHTML = `
                        <span>${escapeHtml(k)}</span>
                        <button type="button" class="keyword-remove" data-idx="${idx}" title="Remove keyword">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    const btn = chip.querySelector('.keyword-remove');
                    btn.addEventListener('click', function () {
                        const i = Number(this.dataset.idx);
                        if (!Number.isNaN(i)) {
                            keywordsAdded.splice(i, 1);
                            renderAddedKeywords();
                        }
                    });
                    addedKeywordsList.appendChild(chip);
                });

                // update hidden input (JSON array)
                keywordsHidden.value = JSON.stringify(keywordsAdded);
            }

            function addKeywordsFromInput() {
                const raw = keywordInput.value || '';
                if (!raw.trim()) {
                    keywordError.style.display = 'block';
                    keywordError.textContent = 'Please enter a keyword or keywords';
                    return;
                }
                keywordError.style.display = 'none';

                // split by comma, allow multiple keywords, trim and filter out empties
                const parts = raw.split(',').map(p => p.trim()).filter(Boolean);

                let addedAny = false;
                parts.forEach(p => {
                    // dedupe case-insensitive
                    const exists = keywordsAdded.some(k => k.toLowerCase() === p.toLowerCase());
                    if (!exists) {
                        keywordsAdded.push(p);
                        addedAny = true;
                    }
                });

                if (addedAny) {
                    renderAddedKeywords();
                }
                keywordInput.value = '';
                keywordInput.focus();
            }

            addKeywordBtn.addEventListener('click', addKeywordsFromInput);

            // allow pressing Enter in input to add
            keywordInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addKeywordsFromInput();
                }
            });

            // -------------------------------
            // FILE UPLOAD: preview + remove (no validation triggered by remove)
            // -------------------------------
            const fileUploadArea = document.getElementById('fileUploadArea');
            const manuscriptFile = document.getElementById('manuscriptFile');
            const fileError = document.getElementById('fileError');
            const filePreview = document.getElementById('filePreview');

            fileUploadArea.addEventListener('click', function () {
                manuscriptFile.click();
            });

            manuscriptFile.addEventListener('change', function (e) {
                handleFiles(this.files);
            });

            fileUploadArea.addEventListener('dragover', function (e) {
                e.preventDefault();
                this.classList.add('dragover');
            });

            fileUploadArea.addEventListener('dragleave', function (e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });

            fileUploadArea.addEventListener('drop', function (e) {
                e.preventDefault();
                this.classList.remove('dragover');

                if (e.dataTransfer.files.length) {
                    handleFiles(e.dataTransfer.files);
                }
            });

            function handleFiles(files) {
                const file = files[0];
                if (!file) return;

                const allowedTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];

                if (!allowedTypes.includes(file.type)) {
                    fileError.style.display = 'block';
                    toastr.error('Please upload a PDF or Word document');
                    return;
                }

                // optional: file size limit (e.g., 10MB)
                const maxSize = 10 * 1024 * 1024;
                if (file.size > maxSize) {
                    fileError.style.display = 'block';
                    fileError.textContent = 'File size exceeds 10MB limit';
                    toastr.error('File size must be less than 10MB');
                    return;
                }

                fileError.style.display = 'none';

                try {
                    const dt = new DataTransfer();
                    dt.items.add(file);
                    manuscriptFile.files = dt.files;
                } catch (err) {
                    console.warn('Could not programmatically set manuscriptFile.files', err);
                }

                filePreview.innerHTML = `
                    <div class="file-preview-item">
                        <div class="file-preview-name">
                            <i class="fas fa-file"></i>
                            <span>${escapeHtml(file.name)}</span>
                        </div>
                        <button type="button" class="file-preview-remove" id="removeFile">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                filePreview.style.display = 'block';

                const removeBtn = document.getElementById('removeFile');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function (evt) {
                        evt.preventDefault();
                        evt.stopPropagation();
                        filePreview.style.display = 'none';
                        try {
                            manuscriptFile.value = '';
                            manuscriptFile.files = new DataTransfer().files;
                        } catch (e) {
                            manuscriptFile.value = '';
                        }
                    });
                }
            }

            // -------------------------------
            // FORM SUBMISSION (with toastr and sweetalert)
            // -------------------------------
            const submitBtn = document.getElementById('submitBtn');

            function setSubmitting(isSubmitting) {
                if (isSubmitting) {
                    submitBtn.dataset.origText = submitBtn.textContent;
                    submitBtn.dataset.origDisabled = submitBtn.disabled ? '1' : '0';
                    submitBtn.dataset.origBg = submitBtn.style.backgroundColor || '';
                    submitBtn.dataset.origColor = submitBtn.style.color || '';

                    const bg = getComputedStyle(document.documentElement).getPropertyValue('--primary-color') || '#cc5500';

                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Submitting...';
                    submitBtn.style.backgroundColor = bg.trim();
                    submitBtn.style.color = '#ffffff';
                    submitBtn.style.opacity = '0.95';
                    submitBtn.setAttribute('aria-busy', 'true');
                } else {
                    submitBtn.disabled = false;
                    submitBtn.textContent = submitBtn.dataset.origText || 'Submit';
                    submitBtn.style.backgroundColor = submitBtn.dataset.origBg || '';
                    submitBtn.style.color = submitBtn.dataset.origColor || '';
                    submitBtn.style.opacity = '';
                    submitBtn.removeAttribute('aria-busy');
                }
            }

            document.getElementById('submissionForm').addEventListener('submit', async function (e) {
                e.preventDefault();

                const scopeVal = selectedScope.value && selectedScope.value.trim();
                const titleVal = document.getElementById('manuscriptTitle').value.trim();
                const abstractText = quill.getText().trim(); // plain text check
                const filePresent = manuscriptFile.files && manuscriptFile.files.length > 0;
                // use authorsAdded array
                const addedAuthorsCount = authorsAdded.length;

                if (!scopeVal && !titleVal && !abstractText && !filePresent && addedAuthorsCount === 0 && keywordsAdded.length === 0) {
                    toastr.error('Cannot submit empty field');
                    return;
                }

                // validations
                if (!scopeVal) {
                    toastr.error('Please select a scope');
                    return;
                }

                if (!titleVal) {
                    toastr.error('Please enter a manuscript title');
                    return;
                }

                if (addedAuthorsCount === 0) {
                    toastr.error('Please add at least one author');
                    return;
                }

                // validate authors (affiliation optional)
                for (let i = 0; i < authorsAdded.length; i++) {
                    const a = authorsAdded[i];
                    if (!a.name || !a.name.trim()) {
                        toastr.error(`Please enter full name for author #${i + 1}`);
                        return;
                    }
                    if (!a.email || !a.email.trim()) {
                        toastr.error(`Please enter email for author #${i + 1}`);
                        return;
                    }
                    if (!isValidEmail(a.email.trim())) {
                        toastr.error(`Author #${i + 1} email is invalid`);
                        return;
                    }
                }

                if (!filePresent) {
                    toastr.error('Please upload a manuscript file');
                    return;
                }

                if (!token) {
                    toastr.error('Missing authentication token. Please login and try again.');
                    return;
                }

                try {
                    setSubmitting(true);

                    const formData = new FormData();
                    formData.append('title', titleVal);
                    formData.append('abstract', document.getElementById('abstractContent').value || '');
                    formData.append('scopeId', scopeVal);

                    // authors: include affiliation array (may be empty)
                    const authorsPayload = authorsAdded.map(a => ({
                        name: a.name,
                        email: a.email,
                        affiliation: Array.isArray(a.affiliation) ? a.affiliation : []
                    }));
                    formData.append('authors', JSON.stringify(authorsPayload));

                    // Keywords: append as JSON array
                    formData.append('keywords', JSON.stringify(keywordsAdded));

                    formData.append('file', manuscriptFile.files[0]);

                    const res = await fetch(`${BASE_URL}/submissions`, {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });

                    const respJson = await res.json().catch(() => null);

                    if (!res.ok) {
                        const message = (respJson && (respJson.message || respJson.error)) || `Submission failed (status ${res.status})`;
                        toastr.error(message);
                    } else if (respJson && respJson.success === false) {
                        const message = respJson.message || respJson.error || 'Submission failed';
                        toastr.error(message);
                    } else {
                        const message = (respJson && (respJson.message || 'Manuscript submitted successfully')) || 'Manuscript submitted successfully';

                        Swal.fire({
                            icon: 'success',
                            title: 'Success!',
                            text: message,
                            confirmButtonColor: '#3085d6'
                        }).then(() => {
                            resetForm();
                        });
                    }
                } catch (err) {
                    console.error('Submit error', err);
                    toastr.error('An error occurred while submitting. Please try again.');
                } finally {
                    setSubmitting(false);
                }
            });

            // Function to reset form to original state
            function resetForm() {
                // Reset scope selection
                selectedScope.value = '';
                selectHeader.querySelector('.select-placeholder').textContent = 'Select a scope';
                selectHeader.classList.remove('open');
                selectDropdown.style.display = 'none';
                selectArrow.classList.remove('open');

                // Reset manuscript title
                document.getElementById('manuscriptTitle').value = '';

                // Reset abstract editor
                quill.setText('');
                document.getElementById('abstractContent').value = '';

                // Reset file upload
                try {
                    manuscriptFile.value = '';
                    manuscriptFile.files = new DataTransfer().files;
                } catch (e) {
                    manuscriptFile.value = '';
                }
                filePreview.style.display = 'none';
                fileError.style.display = 'none';

                // Reset authors - clear added authors and input area
                authorsAdded = [];
                renderAddedAuthors();
                authorInputArea.innerHTML = '';
                createAuthorRow();

                // Reset keywords
                keywordsAdded = [];
                renderAddedKeywords();
                keywordInput.value = '';
                keywordError.style.display = 'none';
                keywordsHidden.value = '';
            }
        });
    </script>
</body>

</html>