<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Submission Details</title>
    <script type="module" src="../assets/js/checkAuth.js"></script>
    <!-- Font Awesome (icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Toastr CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <!-- Global CSS (variables, body, main) -->
    <link rel="stylesheet" href="/assets/css/style.css">
    <!-- Header + Sidebar CSS -->
    <link rel="stylesheet" href="/assets/css/header_sidebar.css">

    <!-- Submission Details CSS -->
    <style>
        :root {
    --bg: #f4f7fb;
    --card-bg: #ffffff;
    --primary: var(--lite-primary-color);
    --primary-light: rgba(255, 122, 24, 0.1);
    --primary-dark: #e56c0e;
    --muted: #6b7280;
    --light: #f8fafc;
    --border: #e2e8f0;
    --success: #10b981;
    --success-light: rgba(16, 185, 129, 0.1);
    --danger: #ef4444;
    --danger-light: rgba(239, 68, 68, 0.1);
    --warning: #f59e0b;
    --warning-light: rgba(245, 158, 11, 0.1);
    --info: #3b82f6;
    --info-light: rgba(59, 130, 246, 0.1);
    --radius: 12px;
    --card-shadow: 0 6px 20px rgba(22, 24, 46, 0.08);
    --card-shadow-hover: 0 18px 40px rgba(22, 24, 46, 0.12);
}

.submission-details-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
}

/* Back Button */
.back-button-wrap {
    margin-bottom: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.back-button {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: var(--light);
    color: #374151;
    border: 1px solid var(--border);
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
    text-decoration: none;
}

.back-button:hover {
    background: #e5e7eb;
    border-color: #9ca3af;
    transform: translateY(-1px);
}

/* Status Notification Section */
.status-notification {
    background: var(--card-bg);
    border-radius: var(--radius);
    box-shadow: var(--card-shadow);
    padding: 1.5rem 2rem;
    margin-bottom: 1.5rem;
    display: none;
    animation: fadeIn 0.5s ease;
    border-left: 4px solid var(--primary);
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.status-notification.published {
    border-left-color: var(--success);
    background: linear-gradient(to right, var(--success-light), var(--card-bg));
}

.status-notification.rejected {
    border-left-color: var(--danger);
    background: linear-gradient(to right, var(--danger-light), var(--card-bg));
}

.status-notification.awaiting_payment {
    border-left-color: var(--warning);
    background: linear-gradient(to right, var(--warning-light), var(--card-bg));
}

.status-notification.accepted {
    border-left-color: var(--success);
    background: linear-gradient(to right, var(--success-light), var(--card-bg));
}

.notification-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.notification-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}

.notification-icon.success {
    background: var(--success-light);
    color: var(--success);
}

.notification-icon.warning {
    background: var(--warning-light);
    color: var(--warning);
}

.notification-icon.danger {
    background: var(--danger-light);
    color: var(--danger);
}

.notification-icon.info {
    background: var(--info-light);
    color: var(--info);
}

.notification-title {
    font-size: 1.3rem;
    font-weight: 700;
    color: #111827;
    margin: 0;
}

.notification-content {
    color: var(--muted);
    line-height: 1.6;
    margin-bottom: 1.5rem;
}

.notification-content p {
    margin: 0 0 0.5rem 0;
}

.notification-content p:last-child {
    margin-bottom: 0;
}

.notification-actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.btn-payment {
    background: var(--warning);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s;
    text-decoration: none;
}

.btn-payment:hover {
    background: #d97706;
    transform: translateY(-2px);
}

/* Manuscript Header Card */
.manuscript-header-card {
    background: var(--card-bg);
    border-radius: var(--radius);
    box-shadow: var(--card-shadow);
    padding: 2rem;
    margin-bottom: 2rem;
    border-left: 4px solid var(--primary);
    position: relative;
    min-height: 180px;
}

.manuscript-header-card h1 {
    font-size: 1.8rem;
    font-weight: 700;
    color: #111827;
    margin-bottom: 1rem;
    line-height: 1.3;
}

.header-status-badge {
    display: inline-block;
    padding: 0.5rem 1.2rem;
    font-weight: 700;
    font-size: 0.85rem;
    border-radius: 20px;
    background: var(--badge-status);
    color: white;
    margin-bottom: 1rem;
    text-transform: capitalize;
}

.header-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 2rem;
    margin-top: 1rem;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--muted);
    font-size: 0.95rem;
}

.meta-item i {
    color: var(--primary);
}

/* Content Sections */
.content-section {
    background: var(--card-bg);
    border-radius: var(--radius);
    box-shadow: var(--card-shadow);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.section-title {
    font-size: 1.3rem;
    font-weight: 600;
    color: #111827;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.section-title i {
    color: var(--primary);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.count-badge {
    background: var(--primary-light);
    color: var(--primary);
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}

/* Abstract Section */
.abstract-content {
    background: var(--light);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.5rem;
    line-height: 1.6;
    color: #374151;
}

.abstract-content p {
    margin: 0 0 1rem 0;
}

.abstract-content p:last-child {
    margin-bottom: 0;
}

/* Authors Section */
.authors-list {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
}

.author-item {
    background: var(--light);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1rem;
    min-width: 200px;
    flex: 1;
}

.author-name {
    font-weight: 600;
    color: #111827;
    margin-bottom: 0.25rem;
}

.author-email {
    color: var(--muted);
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* Assigned Reviewers Section */
.reviewers-container {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    position: relative;
}

.reviewer-card {
    background: var(--light);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1rem;
    min-width: 250px;
    flex: 1;
}

.reviewer-card .reviewer-name {
    font-weight: 600;
    color: #111827;
    margin-bottom: 0.25rem;
}

.reviewer-card .reviewer-email {
    color: var(--muted);
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.reviewer-status {
    font-size: 0.85rem;
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.status-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.status-indicator.pending {
    background-color: var(--warning);
}

.status-indicator.completed {
    background-color: var(--success);
}

.no-reviewers {
    text-align: center;
    padding: 2rem;
    color: var(--muted);
    width: 100%;
}

.no-reviewers i {
    font-size: 2rem;
    margin-bottom: 0.5rem;
    opacity: 0.5;
}

/* Review Details Section - Fixed Height Cards */
.review-details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

.detail-card {
    background: var(--light);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.5rem;
    position: relative;
    min-height: 146px;
    max-height: 146px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.detail-label {
    font-size: 0.9rem;
    color: var(--lite-secondary1);
    font-weight: 600;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-shrink: 0;
}

.detail-content {
    flex: 1;
    overflow: hidden;
    position: relative;
}

.detail-value {
    font-size: 1rem;
    color: #111827;
    line-height: 1.5;
    margin: 0;
    overflow: hidden;
    position: relative;
}

.detail-value.truncated {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    max-height: 4.5em;
}

.detail-value.truncated::after {
    content: '';
    position: absolute;
    bottom: 0;
    right: 0;
    width: 30%;
    height: 1.5em;
    background: linear-gradient(to right, rgba(248, 250, 252, 0), var(--light) 50%);
}

.view-more-btn {
    background: none;
    border: none;
    color: var(--info);
    cursor: pointer;
    padding: 0;
    font-size: 0.85rem;
    font-weight: 500;
    text-decoration: underline;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    margin-top: 0.5rem;
    flex-shrink: 0;
}

.view-more-btn:hover {
    color: #2563eb;
}

.view-all-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: var(--info);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
    text-decoration: none;
    margin-top: 1rem;
}

.view-all-btn:hover {
    background: #2563eb;
    transform: translateY(-2px);
}

/* Revisions Section Styling */
.revisions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

.revision-card {
    background: var(--light);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.5rem;
    transition: all 0.3s ease;
}

.revision-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--card-shadow-hover);
}

.revision-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid var(--primary-light);
}

.revision-title {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.revision-version {
    background: var(--primary);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}

.revision-content {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.revision-item {
    margin-bottom: 0.75rem;
}

.revision-label {
    font-size: 0.9rem;
    color: var(--muted);
    font-weight: 600;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.revision-text {
    font-size: 0.95rem;
    color: #374151;
    line-height: 1.5;
    margin: 0;
    word-wrap: break-word;
}

.revision-text.truncated {
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    max-height: 4.5em;
    position: relative;
}

.revision-text.truncated::after {
    content: '';
    position: absolute;
    bottom: 0;
    right: 0;
    width: 30%;
    height: 1.5em;
    background: linear-gradient(to right, rgba(248, 250, 252, 0), var(--light) 50%);
}

.view-more-link {
    color: var(--info);
    text-decoration: none;
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    margin-top: 0.25rem;
    transition: color 0.2s;
}

.view-more-link:hover {
    color: #2563eb;
    text-decoration: underline;
}

.revision-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border);
    font-size: 0.85rem;
    color: var(--muted);
}

.revision-date {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.view-document-btn {
    background: var(--primary-color);
    color: white;
    border: 1px solid var(--primary);
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
}

.view-document-btn:hover {
    color: white;
    transform: translateY(-1px);
}

.view-all-revisions-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: var(--primary);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
    text-decoration: none;
    margin-top: 1rem;
}

.view-all-revisions-btn:hover {
    opacity: 0.7;
    transform: translateY(-2px);
}

.no-revisions {
    text-align: center;
    padding: 3rem;
    color: var(--muted);
}

.no-revisions i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

/* Abstract truncation styling */
.abstract-content .abstract-text {
    line-height: 1.6;
    color: #374151;
    word-wrap: break-word;
}

.abstract-content .abstract-text.truncated {
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 8;
    -webkit-box-orient: vertical;
    max-height: 12.8em;
    position: relative;
}

.abstract-content .abstract-text.truncated::after {
    content: '';
    position: absolute;
    bottom: 0;
    right: 0;
    width: 30%;
    height: 1.6em;
    background: linear-gradient(to right, rgba(248, 250, 252, 0), var(--light) 50%);
}

.abstract-content .view-more-link {
    margin-top: 0.5rem;
    display: inline-block;
}

/* Unified Modal Styles */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 99999;
    display: none;
    align-items: center;
    justify-content: center;
    pointer-events: none;
}

.modal.active {
    display: flex;
    pointer-events: all;
}

.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.75);
    backdrop-filter: blur(4px);
    z-index: 100000;
}

.modal-content {
    position: relative;
    z-index: 100001;
    background: var(--card-bg);
    border-radius: var(--radius);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    width: 90%;
    max-width: 700px;
    max-height: 85vh;
    overflow-y: auto;
    pointer-events: all;
    margin: 20px;
    animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* Add to your existing CSS in submission details page */

/* Payment Modal Specific Styles */
.payment-modal .modal-content {
    max-width: 500px;
}

/* Ensure modal doesn't close on outside click */
.modal-overlay {
    pointer-events: auto; /* Prevent clicks from passing through */
}

/* Disable close on outside click */
.modal {
    pointer-events: none;
}

.modal.active {
    pointer-events: all;
}

/* Paystack modal z-index fix */
.paystack-modal {
    z-index: 100002 !important; /* Above our modal */
}

/* Payment Step Spinner */
.processing-spinner {
    font-size: 3rem;
    color: var(--primary);
    margin-bottom: 1.5rem;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Payment Modal Buttons */
.modal-footer .btn {
    min-width: 120px;
}

/* Disable backdrop close */
.modal-overlay {
    cursor: default;
}

body.modal-open {
    overflow: hidden;
}

/* Success Actions */
.success-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 1.5rem;
}

/* View Receipt Button */
.btn-view-receipt {
    background: var(--success);
    color: white;
}

.btn-view-receipt:hover {
    background: #0da65c;
}

/* Payment Status Text */
.payment-status-text {
    text-align: center;
    margin: 1rem 0;
    font-size: 0.95rem;
    color: var(--muted);
}

/* Content Modal Specific Styles */
.content-modal .modal-content {
    max-width: 700px;
}

.content-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    background: var(--card-bg);
    z-index: 1;
}

.content-modal-header h3 {
    margin: 0;
    color: #111827;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.modal-content-type {
    font-size: 0.9rem;
    color: var(--muted);
    margin-top: 0.25rem;
    font-weight: normal;
}

.content-modal-body {
    padding: 1.5rem;
    max-height: 60vh;
    overflow-y: auto;
}

.content-display {
    line-height: 1.6;
    color: #374151;
    word-wrap: break-word;
}

.content-display p {
    margin: 0 0 1rem 0;
}

.content-display p:last-child {
    margin-bottom: 0;
}

.content-display strong,
.content-display b {
    font-weight: 600;
}

.content-display em,
.content-display i {
    font-style: italic;
}

.content-display u {
    text-decoration: underline;
}

.content-display ul,
.content-display ol {
    margin: 0 0 1rem 1.5rem;
    padding: 0;
}

.content-display li {
    margin-bottom: 0.5rem;
}

.content-display li:last-child {
    margin-bottom: 0;
}

.content-display h1,
.content-display h2,
.content-display h3,
.content-display h4,
.content-display h5,
.content-display h6 {
    margin: 1.5rem 0 1rem 0;
    color: #111827;
    font-weight: 600;
}

.content-display h1 {
    font-size: 1.8rem;
}

.content-display h2 {
    font-size: 1.5rem;
}

.content-display h3 {
    font-size: 1.3rem;
}

.content-display h4 {
    font-size: 1.1rem;
}

.content-display h5 {
    font-size: 1rem;
}

.content-display h6 {
    font-size: 0.9rem;
}

/* Revised Submission Section */
.revisions-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 2rem;
}

.revision-stats {
    display: flex;
    gap: 2rem;
    align-items: center;
}

.stat-item {
    text-align: center;
}

.stat-number {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary);
    line-height: 1;
}

.stat-label {
    font-size: 0.9rem;
    color: var(--muted);
    margin-top: 0.25rem;
}

/* File Actions */
.file-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
    flex-wrap: wrap;
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
    text-decoration: none;
}

.btn-primary {
    background: var(--primary-color);
    color: white;
    border: 2px solid var(--primary-color);
}

.btn-primary:hover:not(:disabled) {
    background: var(--primary);
    color: white;
    transform: translateY(-2px);
}

.btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-secondary {
    background: var(--light);
    color: var(--lite-secondary1);
    border: 1px solid var(--border);
}

.btn-secondary:hover {
    background: #e5e7eb;
    border-color: #9ca3af;
}

/* Timeline Section */
.timeline-item {
    position: relative;
    margin: 28px 0;
    display: block;
    padding-top: 2px;
    opacity: 0;
    transform: translateY(20px);
    animation: fadeInUp 0.5s ease forwards;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: -24px;
    top: 8px;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: var(--primary);
    box-shadow: 0 0 0 6px rgba(255, 122, 24, 0.1);
    z-index: 2;
}

.timeline-item .card {
    background: var(--card-bg);
    padding: 18px 20px;
    border-radius: var(--radius);
    box-shadow: var(--card-shadow);
    transition: transform .35s cubic-bezier(.16, .84, .24, 1), box-shadow .35s ease;
    will-change: transform;
    position: relative;
    min-height: 78px;
    overflow: hidden;
    border: 1px solid rgba(0, 0, 0, 0.05);
}

.timeline-item .card:hover {
    transform: translateY(-8px);
    box-shadow: var(--card-shadow-hover);
}

.timeline-item .status-badge {
    width: fit-content;
    display: inline-block;
    padding: 0.28rem 1rem;
    font-weight: 700;
    font-size: 0.78rem;
    border-radius: 4px;
    margin-bottom: 12px;
    text-transform: capitalize;
}

.timeline-comment {
    margin: 0.5rem 0;
    color: #111827;
    line-height: 1.5;
}

.timeline-date {
    font-size: 0.8rem;
    color: var(--muted);
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.updated-by {
    font-size: 0.85rem;
    color: var(--muted);
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid rgba(0, 0, 0, 0.05);
}

.updated-by strong {
    color: #374151;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* Modal Close Button */
.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--muted);
    padding: 0.25rem;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.2s;
}

.modal-close:hover {
    color: var(--danger);
    background: rgba(239, 68, 68, 0.1);
}

/* Payment Modal Specific Styles */
#paymentModal .modal-content {
    max-width: 500px;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    background: var(--card-bg);
    z-index: 1;
}

.modal-header h3 {
    margin: 0;
    color: #111827;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.modal-body {
    padding: 1.5rem;
}

.modal-footer {
    padding: 1.5rem;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    position: sticky;
    bottom: 0;
    background: var(--card-bg);
    z-index: 1;
}

/* Payment Step Styles */
.payment-step {
    display: none;
    animation: fadeIn 0.3s ease;
}

.payment-step.active {
    display: block;
}

.payment-info {
    text-align: center;
    padding: 1rem;
}

.payment-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto 1.5rem;
    background: var(--primary-light);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
    color: var(--primary);
}

.payment-info h4 {
    font-size: 1.25rem;
    font-weight: 600;
    color: #111827;
    margin-bottom: 0.5rem;

}

.payment-amount {    
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--primary);
    margin: 0.5rem 0 1rem;
}

.currency-symbol {
    font-size: 1.5rem;
    font-weight: 600;
    margin-right: 0.25rem;
}

.amount-figure {
    font-size: 2.5rem;
    font-weight: 700;
}

.amount-decimals {
    font-size: 1.5rem;
    font-weight: 600;
}

.payment-description {
    color: var(--muted);
    line-height: 1.5;
    margin-bottom: 1.5rem;
}

.payment-details {
    background: var(--light);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1rem;
    text-align: left;
}

.detail-item {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    padding: 0.5rem 0;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

.detail-item:last-child {
    border-bottom: none;
}

.detail-label {
    font-weight: 500;
    color: var(--muted);
    font-size: 0.9rem;
}

.detail-value {
    font-weight: 600;
    color: #111827;
    font-size: 0.9rem;
    word-break: break-all;
    text-align: right;
    max-width: 60%;
}

/* Payment Processing Styles */
.payment-processing {
    text-align: center;
    padding: 2rem 1rem;
}

.processing-spinner {
    font-size: 3rem;
    color: var(--primary);
    margin-bottom: 1.5rem;
    animation: spin 1s linear infinite;
}

.payment-processing h4 {
    font-size: 1.25rem;
    font-weight: 600;
    color: #111827;
    margin-bottom: 0.5rem;
}

.payment-processing p {
    color: var(--muted);
    margin-bottom: 1rem;
}

.processing-status {
    background: var(--light);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 0.75rem;
    font-size: 0.9rem;
    color: var(--muted);
    margin-top: 1.5rem;
}

/* Payment Success Styles */
.payment-success {
    text-align: center;
    padding: 2rem 1rem;
}

.success-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto 1.5rem;
    background: var(--success-light);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
    color: var(--success);
}

.payment-success h4 {
    font-size: 1.25rem;
    font-weight: 600;
    color: #111827;
    margin-bottom: 0.5rem;
}

.payment-success p {
    color: var(--muted);
    margin-bottom: 1.5rem;
}

.success-details {
    background: var(--light);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1rem;
    margin: 1.5rem 0;
    text-align: left;
}

.success-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem 0;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

.success-item:last-child {
    border-bottom: none;
}

.success-item i {
    color: var(--primary);
    font-size: 1rem;
    width: 20px;
}

.success-label {
    font-size: 0.85rem;
    color: var(--muted);
    display: block;
}

.success-value {
    font-weight: 600;
    color: #111827;
    font-size: 0.9rem;
    display: block;
}

.success-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
}

/* Payment Error Styles */
.payment-error {
    text-align: center;
    padding: 2rem 1rem;
}

.error-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto 1.5rem;
    background: var(--danger-light);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
    color: var(--danger);
}

.payment-error h4 {
    font-size: 1.25rem;
    font-weight: 600;
    color: #111827;
    margin-bottom: 0.5rem;
}

.payment-error p {
    color: var(--muted);
    margin-bottom: 1rem;
}

.error-details {
    background: var(--light);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1rem;
    margin: 1.5rem 0;
    text-align: left;
    font-size: 0.85rem;
    color: var(--muted);
}

.error-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
}

/* Loading and Error States */
.loading-screen {
    text-align: center;
    padding: 3rem;
    color: var(--muted);
}

.loading-screen .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #f3f3f3;
    border-top: 4px solid var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
}

@keyframes spin {
    0% {
        transform: rotate(0deg);
    }
    100% {
        transform: rotate(360deg);
    }
}

.error-screen {
    text-align: center;
    padding: 3rem;
    color: var(--muted);
}

.error-screen i {
    color: var(--danger);
    margin-bottom: 1rem;
}

.error-screen h3 {
    color: #111827;
    margin-bottom: 0.5rem;
}

.retry-btn {
    background: var(--primary);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 6px;
    cursor: pointer;
    margin-top: 1rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s;
}

.retry-btn:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
}

/* Skeleton Loading */
.skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 4px;
}

.skeleton-icon {
    background: #f0f0f0;
    border-radius: 50%;
}

@keyframes loading {
    0% {
        background-position: 200% 0;
    }
    100% {
        background-position: -200% 0;
    }
}

/* Edit Button Styling */
.edit-btn {
    background: var(--btn-bg);
    color: white;
    border: none;
    padding: 0.5rem 1.5rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.edit-btn:hover {
    background: #e56c0e;
    transform: translateY(-2px);
}

.edit-btn:active {
    transform: translateY(0);
}

/* Responsive Design */
@media (max-width: 768px) {
    .submission-details-container {
        padding: 0 0.5rem;
    }

    .manuscript-header-card {
        padding: 1.5rem;
    }

    .manuscript-header-card h1 {
        font-size: 1.5rem;
    }

    .header-meta {
        flex-direction: column;
        gap: 1rem;
    }

    .content-section {
        padding: 1rem;
    }

    .revisions-container {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }

    .revision-stats {
        width: 100%;
        justify-content: space-between;
    }

    .file-actions {
        flex-direction: column;
    }

    .btn {
        width: 100%;
        justify-content: center;
    }

    .review-details-grid {
        grid-template-columns: 1fr;
    }

    .revisions-grid {
        grid-template-columns: 1fr;
    }

    .revision-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
    }

    .revision-meta {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
    }

    .view-document-btn {
        width: 100%;
        justify-content: center;
    }

    .modal-content {
        width: 95%;
        max-height: 90vh;
        margin: 10px;
    }

    .reviewer-card,
    .author-item {
        min-width: 100%;
    }

    .back-button-wrap {
        flex-direction: column;
        gap: 1rem;
        align-items: flex-start;
    }

    .edit-btn {
        width: 100%;
        justify-content: center;
    }

    .back-button {
        width: 100%;
        justify-content: center;
    }

    .status-notification {
        padding: 1rem;
    }

    .notification-actions {
        flex-direction: column;
    }

    .btn-payment {
        width: 100%;
        justify-content: center;
    }

    /* Modal Responsive Styles */
    .content-modal .modal-content,
    #paymentModal .modal-content {
        max-width: 95%;
    }

    .modal-body,
    .content-modal-body {
        padding: 1rem;
    }

    .modal-header,
    .content-modal-header {
        padding: 1rem;
    }

    .modal-footer {
        padding: 1rem;
        flex-direction: column;
    }

    .success-actions,
    .error-actions {
        flex-direction: column;
    }

    .success-actions .btn,
    .error-actions .btn {
        width: 100%;
        justify-content: center;
    }

    .payment-details,
    .success-details,
    .error-details {
        padding: 0.75rem;
    }

    .detail-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.25rem;
    }

    .detail-value {
        text-align: left;
        max-width: 100%;
    }
}

@media (max-width: 480px) {
    .revision-card {
        padding: 1rem;
    }

    .content-modal-body {
        padding: 1rem;
    }

    .modal-content {
        width: 95%;
        margin: 5px;
    }
}
    </style>
</head>

<body>
    <div class="dashboard-container">
        <!-- Sidebar Included-->
        <div id="sidebar-placeholder"></div>
        <div class="main-content-wrapper">
            <!-- Header Included-->
            <div id="header-placeholder"></div>

            <main class="main-content">
                <!-- Back Button and Edit Button -->
                <div class="back-button-wrap">
                    <a href="my-submissions.html" class="back-button">
                        <i class="fas fa-arrow-left"></i> Back to My Submissions
                    </a>
                
                    <button id="editSubmissionBtn" class="edit-btn" style="display: none;">
                                        <i class="fas fa-edit"></i> Edit Submission
                        </button>
                </div>
                <!-- Status Notification Section -->
                <div id="statusNotification" class="status-notification" style="display: none;">
                    <div class="notification-header">
                        <div id="notificationIcons" class="notification-icon">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <h3 id="notificationTitle" class="notification-title"></h3>
                    </div>
                    <div id="notificationContent" class="notification-content">
                        <!-- Notification content will be populated here -->
                    </div>
                    <div id="notificationActions" class="notification-actions">
                        <!-- Action buttons will be populated here -->
                    </div>
                </div>

                <div class="submission-details-container">
                    <!-- Manuscript Header Card -->
                    <div id="manuscriptHeader" class="manuscript-header-card">
                        <!-- Skeleton Loading -->
                        <div class="skeleton" style="height: 32px; width: 70%; margin-bottom: 1rem;"></div>
                        <div class="skeleton" style="height: 28px; width: 40%; margin-bottom: 1rem;"></div>
                        <div class="header-meta">
                            <div class="meta-item">
                                <div class="skeleton-icon" style="width: 16px; height: 16px; min-width: 16px;"></div>
                                <div class="skeleton" style="height: 20px; width: 150px;"></div>
                            </div>
                            <div class="meta-item">
                                <div class="skeleton-icon" style="width: 16px; height: 16px; min-width: 16px;"></div>
                                <div class="skeleton" style="height: 20px; width: 180px;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Loading Screen -->
                    <div id="loadingScreen" class="loading-screen">
                        <div class="spinner"></div>
                        <p>Loading submission details...</p>
                    </div>

                    <!-- Error Screen -->
                    <div id="errorScreen" class="error-screen" style="display: none;">
                        <i class="fas fa-exclamation-triangle fa-3x"></i>
                        <h3>Failed to load submission</h3>
                        <p id="errorMessage">An error occurred while loading the submission.</p>
                        <button class="retry-btn" onclick="window.location.reload()">
                            <i class="fas fa-redo"></i> Try Again
                        </button>
                    </div>

                    <!-- Content (hidden until loaded) -->
                    <div id="contentContainer" style="display: none;">
                        <!-- Abstract Section -->
                        <div id="abstractSection" class="content-section" style="display: none;">
                            <h2 class="section-title">
                                <i class="fas fa-align-left"></i> Abstract
                            </h2>
                            <div id="abstractContent" class="abstract-content">
                                <!-- Abstract will be populated here -->
                            </div>
                        </div>

                        <!-- Authors Section -->
                        <div class="content-section">
                            <h2 class="section-title">
                                <i class="fas fa-users"></i> Authors
                            </h2>
                            <div id="authorsList" class="authors-list">
                                <!-- Authors will be populated here -->
                            </div>
                        </div>

                        <!-- Assigned Reviewers Section -->
                        <div id="assignedReviewersSection" class="content-section" style="display: none;">
                            <div class="section-header">
                                <h2 class="section-title">
                                    <i class="fas fa-user-check"></i> Assigned Reviewers
                                </h2>
                                <span id="reviewersCount" class="count-badge">0</span>
                            </div>
                            <div id="assignedReviewers" class="reviewers-container">
                                <!-- Reviewers will be populated here -->
                            </div>
                        </div>

                        <!-- File Actions Section -->
                        <div class="content-section">
                            <h2 class="section-title">
                                <i class="fas fa-file"></i> Manuscript File
                            </h2>
                            <div class="file-actions">
                                <button id="viewDocumentBtn" class="btn btn-primary" style="display: none;">
                                    <i class="fas fa-eye"></i> View Document
                                </button>
                                <button id="downloadBtn" class="btn btn-secondary">
                                    <i class="fas fa-download"></i> Download
                                </button>
                            </div>
                        </div>

                        <!-- Review Details Section -->
                        <div id="reviewDetailsSection" class="content-section reviewDetailsSection">
                            <div class="section-header">
                                <h2 class="section-title">
                                    <i class="fas fa-clipboard-check"></i> Review Details
                                </h2>
                                <!-- <a id="viewAllReviewsBtn" class="view-all-btn" style="display: none;">
                                    <i class="fas fa-external-link-alt"></i> View All Reviews
                                </a> -->
                            </div>
                            <div class="review-details-grid">
                                <div class="detail-card">
                                    <div class="detail-label">
                                        <i class="fas fa-sync-alt"></i> Revision Count
                                    </div>
                                    <div id="rvCount" class="detail-value">0</div>
                                </div>
                                <div id="editorialDecisionCard" class="detail-card" style="display: none;">
                                    <div class="detail-label">
                                        <i class="fas fa-gavel"></i> Editorial Decision
                                    </div>
                                    <div id="editorialDecision" class="detail-value">
                                        <!-- Decision content will be populated here -->
                                    </div>
                                </div>
                                <div id="reviewerFeedbackCard" class="detail-card" style="display: none;">
                                    <div class="detail-label">
                                        <i class="fas fa-comment"></i> Reviewer Feedback
                                    </div>
                                    <div id="reviewerFeedback" class="detail-value">
                                        <!-- Reviewer feedback will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Revisions Section -->
                        <div id="revisionsSection" class="content-section" style="display: none;">
                            <div class="section-header">
                                <h2 class="section-title">
                                    <i class="fas fa-history"></i> Revisions
                                </h2>
                                <button id="viewAllRevisionsBtn" class="view-all-revisions-btn" style="display: none;">
                                    <i class="fas fa-external-link-alt"></i> View All Revisions
                                </button>
                            </div>
                            <div id="revisionsContainer">
                                <!-- Revisions will be populated here -->
                            </div>
                        </div>

                        <!-- Revised Submission Section -->
                        <div id="revisedSection" class="content-section" style="display: none;">
                            <div class="section-header">
                                <h2 class="section-title">
                                    <i class="fas fa-redo"></i> Revised Submission
                                </h2>
                                <span id="revisionCountDisplay" class="count-badge">0 revisions</span>
                            </div>
                            <div class="revisions-container">
                                <div class="revision-stats">
                                    <div class="stat-item">
                                        <div id="totalRevisions" class="stat-number">0</div>
                                        <div class="stat-label">Total Revisions</div>
                                    </div>
                                    <div class="stat-item">
                                        <div id="latestRevision" class="stat-number">-</div>
                                        <div class="stat-label">Latest Revision</div>
                                    </div>
                                </div>
                                <button id="resubmitBtn" class="btn btn-primary">
                                    <i class="fas fa-upload"></i> Resubmit Manuscript
                                </button>
                            </div>
                        </div>

                        <!-- Timeline Section -->
                        <div class="content-section">
                            <div class="section-header">
                                <h2 class="section-title">
                                    <i class="fas fa-history"></i> Timeline
                                </h2>
                                <button id="viewFullTimelineBtn" class="btn btn-secondary">
                                    <i class="fas fa-external-link-alt"></i> View Full Timeline
                                </button>
                            </div>
                            <div id="recentTimeline">
                                <!-- Recent timeline events will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Content Display Modal -->
    <div id="contentModal" class="modal content-modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="content-modal-header">
                <div>
                    <h3 id="contentModalTitle">Content Details</h3>
                    <div id="contentModalType" class="modal-content-type"></div>
                </div>
                <button class="modal-close" id="closeContentModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="content-modal-body">
                <div id="contentDisplay" class="content-display">
                    <!-- Content will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal payment-modal">
        <div class="modal-overlay"></div>
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-credit-card"></i> Complete Payment</h3>
                <button class="modal-close" id="closePaymentModal">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Payment Step 1: Confirmation -->
                <div id="paymentConfirmationStep" class="payment-step active">
                    <!-- Update the payment amount section in your modal -->
                    <div class="payment-info">
                        <div class="payment-icon">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                        <h4>Publication Fee</h4>
                        <p id="paymentAmount" class="payment-amount">
                            <!-- Amount will be inserted here dynamically -->
                            <span class="currency-symbol"></span>
                            <span class="amount-figure"></span>
                            <span class="amount-decimals"></span>
                        </p>
                        <p class="payment-description">
                            Publication fee for manuscript: <strong id="paymentManuscriptTitle"></strong>
                        </p>
                        <div class="payment-details">
                            <div class="detail-item">
                                <span class="detail-label">Journal:</span>
                                <span id="paymentJournalName" class="detail-value"></span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Submission ID:</span>
                                <span id="paymentSubmissionId" class="detail-value"></span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Payment Reference:</span>
                                <span id="paymentReference" class="detail-value">Will be generated</span>
                            </div>
                            <!-- You can also add a fee breakdown if needed -->
                            <div class="detail-item">
                                <span class="detail-label">Fee Type:</span>
                                <span class="detail-value">Publication Fee</span>
                            </div>
                        </div>
                    </div>
                </div>
    
                <!-- Payment Step 2: Processing -->
                <div id="paymentProcessingStep" class="payment-step">
                    <div class="payment-processing">
                        <div class="processing-spinner">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                        <h4>Processing Payment</h4>
                        <p class="payment-status-text" id="processingStatus">
                            Initializing payment gateway...
                        </p>
                        <div class="payment-status-text">
                            <small>Please don't close this window while payment is in progress</small>
                        </div>
                    </div>
                </div>
    
                <!-- Payment Step 3: Success -->
                <div id="paymentSuccessStep" class="payment-step">
                    <div class="payment-success">
                        <div class="success-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h4>Payment Successful!</h4>
                        <p class="payment-status-text">Your payment has been processed successfully.</p>
                        <div class="success-details">
                            <div class="success-item">
                                <i class="fas fa-receipt"></i>
                                <div>
                                    <span class="success-label">Reference:</span>
                                    <span id="successReference" class="success-value"></span>
                                </div>
                            </div>
                            <div class="success-item">
                                <i class="fas fa-calendar-check"></i>
                                <div>
                                    <span class="success-label">Paid On:</span>
                                    <span id="successDate" class="success-value"></span>
                                </div>
                            </div>
                        </div>
                        <div class="success-actions">
                            <button id="viewReceiptBtn" class="btn btn-view-receipt">
                                <i class="fas fa-receipt"></i> View Receipt
                            </button>
                            <button id="closeSuccessBtn" class="btn btn-secondary">
                                <i class="fas fa-check"></i> Done
                            </button>
                        </div>
                    </div>
                </div>
    
                <!-- Payment Step 4: Error -->
                <div id="paymentErrorStep" class="payment-step">
                    <div class="payment-error">
                        <div class="error-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h4>Payment Failed</h4>
                        <p id="errorMessage" class="payment-status-text">There was an error processing your payment.</p>
                        <div class="error-details" id="errorDetails">
                            <!-- Error details will be shown here -->
                        </div>
                        <div class="error-actions">
                            <button id="retryPaymentBtn" class="btn btn-primary">
                                <i class="fas fa-redo"></i> Try Again
                            </button>
                            <button id="closeErrorBtn" class="btn btn-secondary">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" id="paymentModalFooter">
                <button id="confirmPaymentBtn" class="btn btn-primary">
                    <i class="fas fa-credit-card"></i> Proceed to Payment
                </button>
                <button id="cancelPaymentBtn" class="btn btn-secondary">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    <script>
        window.SIDEBAR_MODULE = 'author';
        window.SIDEBAR_ACTIVE_ID = 'view-submission';
    </script>
    <!-- layout.js loads partials and wires header+sidebar behaviors -->
    <script src="/assets/js/layout.js"></script>
    <!-- jQuery (for toastr) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Toastr -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script type="module">
        // submission-details-fixed.js
            import { BASE_URL, getAuthToken2 } from '/assets/js/utility.js';

            class AuthorSubmissionDetailsManager {
                constructor() {
                    // safe retrieval of submission id
                    this.submissionId = this.getSubmissionIdFromURL();
                    this.submission = null;
                    this.editorialDecision = null;
                    this.reviewerFeedback = null;
                    this.userCache = new Map();
                    this.journalCache = new Map();
                    this.currentModalContent = '';
                    this.currentModalType = '';
                    this.currentModalTitle = '';
                    this.paymentReference = null;
                    this.paymentAuthorizationUrl = null;
                    this.paymentTimer = null;
                    this.currentStep = 'confirmation';
                    this.verificationInterval = null;
                    this.publicationFee = null;
                    this.currency = 'NGN';
                    this.paymentData = null;
                    this.paymentId = null;
                    this.refreshOnClose = false;

                    if (!this.submissionId) {
                        this.showError('No submission ID provided');
                        return;
                    }

                    this.initializeToastr();
                    this.bindEvents();
                    this.initialize();
                }

                // Safe getter for URL id
                getSubmissionIdFromURL() {
                    try {
                        const params = new URLSearchParams(window.location.search);
                        return params.get('id');
                    } catch (err) {
                        console.warn('getSubmissionIdFromURL error', err);
                        return null;
                    }
                }

                initializeToastr() {
                    if (window.toastr) {
                        toastr.options = {
                            closeButton: false,
                            progressBar: false,
                            positionClass: "toast-top-right",
                            timeOut: 3000,
                            extendedTimeOut: 1000
                        };
                    }
                }

                bindEvents() {
                    document.getElementById('viewFullTimelineBtn')?.addEventListener('click', () => {
                        window.location.href = `timeline.html?id=${this.submissionId}`;
                    });

                    document.getElementById('resubmitBtn')?.addEventListener('click', () => {
                        window.location.href = `resubmission.html?id=${this.submissionId}`;
                    });

                    document.getElementById('viewAllReviewsBtn')?.addEventListener('click', (e) => {
                        e.preventDefault();
                        window.location.href = `author-review-details.html?id=${this.submissionId}`;
                    });

                    document.getElementById('viewAllRevisionsBtn')?.addEventListener('click', () => {
                        window.location.href = `revision-history.html?id=${this.submissionId}`;
                    });

                    document.getElementById('closeContentModal')?.addEventListener('click', () => this.closeContentModal());
                    document.getElementById('contentModal')?.addEventListener('click', (e) => {
                        if (e.target.classList.contains('modal-overlay')) this.closeContentModal();
                    });

                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape') this.closeContentModal();
                    });

                    document.getElementById('editSubmissionBtn')?.addEventListener('click', () => {
                        if (this.submissionId) {
                            window.location.href = `/author/edit-submission.html?id=${this.submissionId}`;
                        } else {
                            toastr?.error('Submission ID not found', 'Error');
                        }
                    });

                    // Payment bindings
                    this.bindPaymentEvents();
                }

                /* ---------- Payment bindings ---------- */
                bindPaymentEvents() {
                    document.addEventListener('click', (e) => {
                        const t = e.target;
                        if (!t) return;
                        if (t.id === 'makePaymentBtn' || (t.closest && t.closest('#makePaymentBtn'))) {
                            e.preventDefault();
                            e.stopPropagation();
                            this.openPaymentModal();
                        }
                    });

                    const paymentModal = document.getElementById('paymentModal');
                    const closePaymentModalBtn = document.getElementById('closePaymentModal');
                    const cancelPaymentBtn = document.getElementById('cancelPaymentBtn');
                    const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');
                    const closeErrorBtn = document.getElementById('closeErrorBtn');
                    const closeSuccessBtn = document.getElementById('closeSuccessBtn');
                    const retryPaymentBtn = document.getElementById('retryPaymentBtn');
                    const viewReceiptBtn = document.getElementById('viewReceiptBtn');

                    if (closePaymentModalBtn) closePaymentModalBtn.addEventListener('click', () => this.onCloseAfterResult(true));
                    if (cancelPaymentBtn) cancelPaymentBtn.addEventListener('click', () => this.onCancelPayment());
                    if (confirmPaymentBtn) confirmPaymentBtn.addEventListener('click', () => this.initiatePayment());
                    if (closeErrorBtn) closeErrorBtn.addEventListener('click', () => this.onCloseAfterResult());
                    if (closeSuccessBtn) closeSuccessBtn.addEventListener('click', () => this.onCloseAfterResult());
                    if (retryPaymentBtn) retryPaymentBtn.addEventListener('click', () => this.retryPayment());
                    if (viewReceiptBtn) viewReceiptBtn.addEventListener('click', async () => {
                        await this.viewReceipt();
                    });

                    if (paymentModal) {
                        paymentModal.addEventListener('click', (e) => {
                            if (e.target.classList.contains('modal-overlay')) {
                                // intentionally do not close on overlay click when payment in progress
                                e.stopPropagation();
                            }
                        });
                    }

                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape' && paymentModal && paymentModal.classList.contains('active')) {
                            // don't let ESC close the payment modal unexpectedly
                            e.preventDefault();
                        }
                    });
                }

                onCancelPayment() {
                    // allow cancel to close the modal (force)
                    this.closePaymentModal(true);
                }

                // Called when closing after success or error - refreshes if flag set
                onCloseAfterResult(force = false) {
                    this.closePaymentModal(force);
                }

                /* ---------- Ensure notification DOM nodes exist ---------- */
                ensureNotificationNodes() {
                    const statusNotification = document.getElementById('statusNotification');
                    if (!statusNotification) return null;

                    // If expected child elements don't exist, create them (so later code can safely reference by id)
                    const ensure = (id, className = '') => {
                        let el = document.getElementById(id);
                        if (!el) {
                            el = document.createElement('div');
                            el.id = id;
                            if (className) el.className = className;
                            statusNotification.appendChild(el);
                        }
                        return el;
                    };

                    // We expect structure: notificationIcons, notificationTitle, notificationContent, notificationActions
                    ensure('notificationIcons', 'notification-icon');
                    ensure('notificationTitle', 'notification-title');
                    ensure('notificationContent', 'notification-content');
                    ensure('notificationActions', 'notification-actions');

                    return {
                        statusNotification,
                        notificationIcons: document.getElementById('notificationIcons'),
                        notificationTitle: document.getElementById('notificationTitle'),
                        notificationContent: document.getElementById('notificationContent'),
                        notificationActions: document.getElementById('notificationActions')
                    };
                }

                showStatusLoading() {
                    const statusNotification = document.getElementById('statusNotification');
                    if (!statusNotification) return;

                    // ensure the child nodes we'll write into exist
                    const nodes = this.ensureNotificationNodes();
                    if (!nodes) return;

                    statusNotification.className = 'status-notification loading';
                    statusNotification.style.display = 'block';

                    // Fill nodes in a safe way
                    if (nodes.notificationIcons) nodes.notificationIcons.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
                    if (nodes.notificationTitle) nodes.notificationTitle.textContent = 'Loading...';
                    if (nodes.notificationContent) nodes.notificationContent.innerHTML = `<p>Loading status information...</p>`;
                    if (nodes.notificationActions) nodes.notificationActions.innerHTML = '';
                }

                /* ---------- Initialization / load ---------- */
                async initialize() {
                    try {
                        this.showStatusLoading();
                        this.showLoading();

                        await this.loadMainSubmissionData();
                        await this.loadReviewDetails();
                        await this.loadAssignedReviewers();
                        await this.loadLatestTimelineEvent();

                        this.hideLoading();
                        this.showContent();

                        // Now render actual notification (safe)
                        this.checkAndShowStatusNotification();

                        this.handleEditButtonVisibility();
                    } catch (error) {
                        console.error('Error initializing:', error);
                        this.showError('Failed to load submission details. Please try again.');
                    }
                }

                async loadMainSubmissionData() {
                    try {
                        const token = getAuthToken2();
                        if (!token) throw new Error('Authentication token not found');

                        const response = await fetch(`${BASE_URL}/submissions/${this.submissionId}`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Accept': 'application/json'
                            }
                        });

                        if (!response.ok) {
                            throw new Error(`Failed to fetch submission: ${response.status}`);
                        }

                        const data = await response.json();
                        if (!data.success) throw new Error(data.message || 'Failed to load submission');

                        this.submission = data.submission || data;

                        // submitter
                        const submittedEvent = (this.submission.history || []).find(ev => ev.status === 'submitted');
                        if (submittedEvent?.by) {
                            const submitter = await this.getUserDetails(submittedEvent.by);
                            if (submitter) {
                                this.submission.submitterName = `${submitter.firstName || ''} ${submitter.lastName || ''}`.trim();
                                this.submission.submitterEmail = submitter.email;
                            }
                        }

                        // journal
                        if (this.submission.journalId && this.submission.journalId._id) {
                            const journal = await this.getJournalDetails(this.submission.journalId._id);
                            if (journal) {
                                this.submission.journalId = {
                                    ...this.submission.journalId,
                                    title: journal.title || this.submission.journalId.title,
                                    issn: journal.issn || this.submission.journalId.issn,
                                    publicationFee: journal.publicationFee,
                                    currency: journal.currency
                                };
                                this.publicationFee = journal.publicationFee || this.publicationFee;
                                this.currency = journal.currency || this.currency;
                            }
                        }

                        this.renderManuscriptHeader();
                        this.renderAbstract();
                        this.renderAuthors();
                        this.setupFileActions();
                        this.renderRevisions();
                    } catch (error) {
                        console.error('Error loading submission data:', error);
                        throw error;
                    }
                }

                checkAndShowStatusNotification() {
                    if (!this.submission) return;
                    const status = (this.submission.currentStatus || this.submission.status || '').toLowerCase();
                    const nodemap = this.ensureNotificationNodes();
                    if (!nodemap) return;

                    const { statusNotification, notificationIcons, notificationTitle, notificationContent, notificationActions } = nodemap;

                    // hide by default
                    if (statusNotification) statusNotification.style.display = 'none';

                    const statusConfigs = {
                        'awaiting_payment': {
                            title: 'Awaiting Payment',
                            message: 'Your submission has been approved and is ready for publication. To continue, complete payment.',
                            iconHtml: '<i class="fas fa-credit-card"></i>',
                            iconClass: 'warning',
                            actionsHtml: '<button id="makePaymentBtn" class="btn-payment"><i class="fas fa-credit-card"></i> Make Payment</button>'
                        },
                        'rejected': {
                            title: 'Submission Rejected',
                            message: 'We regret to inform you that your submission was not accepted for publication.',
                            iconHtml: '<i class="fas fa-times-circle"></i>',
                            iconClass: 'danger',
                            actionsHtml: ''
                        },
                        'published': {
                            title: 'Published',
                            message: 'Your manuscript has been published.',
                            iconHtml: '<i class="fas fa-check-circle"></i>',
                            iconClass: 'success',
                            actionsHtml: '<a href="published.html" class="btn btn-secondary"><i class="fas fa-external-link-alt"></i> View Published Article</a>'
                        },
                        'accepted': {
                            title: 'Accepted',
                            message: 'Your submission has been accepted for publication.',
                            iconHtml: '<i class="fas fa-check-circle"></i>',
                            iconClass: 'success',
                            actionsHtml: ''
                        }
                    };

                    const config = statusConfigs[status];

                    if (!config) {
                        if (statusNotification) statusNotification.style.display = 'none';
                        return;
                    }

                    if (statusNotification) {
                        statusNotification.className = `status-notification ${status}`;
                        statusNotification.style.display = 'block';
                    }
                    if (notificationTitle) notificationTitle.textContent = config.title;
                    if (notificationContent) notificationContent.innerHTML = `<p>${config.message}</p>`;
                    if (notificationActions) notificationActions.innerHTML = config.actionsHtml || '';
                    if (notificationIcons) {
                        notificationIcons.className = `notification-icon ${config.iconClass}`;
                        notificationIcons.innerHTML = config.iconHtml || '';
                    }
                }

                handleEditButtonVisibility() {
                    if (!this.submission) return;
                    const status = (this.submission.currentStatus || this.submission.status || '').toLowerCase();
                    const editButton = document.getElementById('editSubmissionBtn');
                    const hideEditForStatuses = ['accepted', 'rejected', 'awaiting_payment', 'published'];
                    if (!editButton) return;
                    editButton.style.display = hideEditForStatuses.includes(status) ? 'none' : 'block';
                }

                /* ---------- Payment modal open/close ---------- */
                openPaymentModal() {
                    if (!this.submission) {
                        toastr?.error('Submission data not loaded', 'Error');
                        return;
                    }

                    const paymentModal = document.getElementById('paymentModal');
                    const paymentManuscriptTitle = document.getElementById('paymentManuscriptTitle');
                    const paymentJournalName = document.getElementById('paymentJournalName');
                    const paymentSubmissionId = document.getElementById('paymentSubmissionId');
                    const paymentAmount = document.getElementById('paymentAmount');

                    if (!paymentModal || !paymentManuscriptTitle || !paymentJournalName || !paymentSubmissionId || !paymentAmount) {
                        console.warn('Payment modal elements missing');
                        return;
                    }

                    paymentManuscriptTitle.textContent = this.submission.title || 'Untitled Manuscript';
                    paymentJournalName.textContent = this.submission.journalId?.title || 'Unknown Journal';
                    paymentSubmissionId.textContent = this.submissionId;

                    const fee = this.publicationFee || 15000;
                    paymentAmount.innerHTML = this.formatCurrency(fee, this.currency || 'NGN');

                    this.resetPaymentModal();
                    this.showPaymentStep('confirmation');

                    paymentModal.classList.add('active');
                    document.body.classList.add('modal-open');
                    document.body.style.overflow = 'hidden';
                }

                // inside the class
                formatCurrency(amount, currency = 'NGN') {
                    // defensive
                    if (amount === undefined || amount === null || isNaN(Number(amount))) {
                        return `<span class="currency-symbol"></span><span class="amount-figure">0</span><span class="amount-decimals">.00</span>`;
                    }

                    // ensure numeric and two decimals
                    const numeric = Number(amount);
                    const formatted = numeric.toFixed(2);
                    const [whole, decimals] = formatted.split('.');

                    let currencySymbol = '';
                    if (String(currency).toUpperCase() === 'USD') currencySymbol = '$';
                    if (String(currency).toUpperCase() === 'EUR') currencySymbol = '';
                    if (String(currency).toUpperCase() === 'GBP') currencySymbol = '';

                    const wholeFormatted = parseInt(whole, 10).toLocaleString();

                    return `
                    <span class="currency-symbol">${currencySymbol}</span>
                    <span class="amount-figure">${wholeFormatted}</span>
                    <span class="amount-decimals">.${decimals}</span>
                `;
                }


                resetPaymentModal() {
                    this.showPaymentStep('confirmation');
                    this.currentStep = 'confirmation';
                    this.paymentReference = null;
                    this.paymentData = null;
                    this.paymentId = null;
                    this.refreshOnClose = false;

                    const paymentReference = document.getElementById('paymentReference');
                    const processingStatus = document.getElementById('processingStatus');
                    const successReference = document.getElementById('successReference');
                    const successDate = document.getElementById('successDate');
                    const errorMessage = document.getElementById('errorMessage');
                    const errorDetails = document.getElementById('errorDetails');

                    if (paymentReference) paymentReference.textContent = 'Will be generated';
                    if (processingStatus) processingStatus.textContent = 'Initializing payment gateway...';
                    if (successReference) successReference.textContent = '';
                    if (successDate) successDate.textContent = '';
                    if (errorMessage) errorMessage.textContent = 'There was an error processing your payment.';
                    if (errorDetails) errorDetails.innerHTML = '';

                    this.disableModalClose(false);
                    this.updateModalFooter();
                }

                showPaymentStep(step) {
                    const steps = ['confirmation', 'processing', 'success', 'error'];
                    steps.forEach(s => {
                        const el = document.getElementById(`payment${s.charAt(0).toUpperCase() + s.slice(1)}Step`);
                        if (el) el.classList.remove('active');
                    });
                    const activeEl = document.getElementById(`payment${step.charAt(0).toUpperCase() + step.slice(1)}Step`);
                    if (activeEl) activeEl.classList.add('active');
                    this.currentStep = step;
                    this.updateModalFooter();
                }

                updateModalFooter() {
                    const modalFooter = document.getElementById('paymentModalFooter');
                    const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');
                    const cancelPaymentBtn = document.getElementById('cancelPaymentBtn');
                    if (!modalFooter || !confirmPaymentBtn || !cancelPaymentBtn) return;

                    switch (this.currentStep) {
                        case 'confirmation':
                            modalFooter.style.display = 'flex';
                            confirmPaymentBtn.style.display = 'inline-flex';
                            cancelPaymentBtn.style.display = 'inline-flex';
                            confirmPaymentBtn.disabled = false;
                            cancelPaymentBtn.disabled = false;
                            confirmPaymentBtn.innerHTML = '<i class="fas fa-credit-card"></i> Proceed to Payment';
                            break;
                        case 'processing':
                            modalFooter.style.display = 'none';
                            break;
                        case 'success':
                        case 'error':
                            modalFooter.style.display = 'none';
                            break;
                    }
                }

                disableModalClose(disable) {
                    const closePaymentModal = document.getElementById('closePaymentModal');
                    const cancelPaymentBtn = document.getElementById('cancelPaymentBtn');
                    if (closePaymentModal) {
                        closePaymentModal.disabled = !!disable;
                        closePaymentModal.style.opacity = disable ? '0.5' : '1';
                        closePaymentModal.style.cursor = disable ? 'not-allowed' : 'pointer';
                    }
                    if (cancelPaymentBtn) {
                        cancelPaymentBtn.disabled = !!disable;
                        cancelPaymentBtn.style.opacity = disable ? '0.5' : '1';
                        cancelPaymentBtn.style.cursor = disable ? 'not-allowed' : 'pointer';
                    }
                }

                /* ---------- Initiate payment ---------- */
                async initiatePayment() {
                    try {
                        const token = getAuthToken2();
                        if (!token) {
                            toastr?.error('Authentication required. Please login again.', 'Error');
                            this.showPaymentError('Authentication required');
                            return;
                        }

                        this.showPaymentStep('processing');
                        this.disableModalClose(true);

                        const payload = { submissionId: this.submissionId };
                        if (this.publicationFee) {
                            payload.amount = Number(this.publicationFee) * 100;
                            payload.currency = this.currency || 'NGN';
                        }

                        const res = await fetch(`${BASE_URL}/payments/initiate`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify(payload)
                        });

                        const text = await res.text();
                        let data;
                        try { data = text ? JSON.parse(text) : {}; } catch (err) { throw new Error('Invalid response from payment server'); }

                        if (!res.ok) throw new Error(data.message || `Payment initiation failed: ${res.status}`);
                        if (!data.success) throw new Error(data.message || 'Payment initiation failed');

                        const paymentData = data.paymentData || data;
                        this.paymentData = paymentData;

                        // pick reference & auth url robustly
                        this.paymentReference = paymentData.reference || paymentData.ref || data.reference || this.paymentReference;
                        this.paymentAuthorizationUrl = data.authorizationUrl || data.authorization_url || paymentData.authorizationUrl || paymentData.authorization_url || this.paymentAuthorizationUrl;

                        // show reference if available
                        const paymentReferenceEl = document.getElementById('paymentReference');
                        if (paymentReferenceEl && this.paymentReference) paymentReferenceEl.textContent = this.paymentReference;

                        // If API provided inline Paystack key & details, open inline
                        const hasInlineKey = paymentData && (paymentData.key || paymentData.publicKey);
                        const hasRef = paymentData && (paymentData.reference || paymentData.ref || this.paymentReference);

                        if (hasInlineKey && hasRef) {
                            paymentData.publicKey = paymentData.publicKey || paymentData.key;
                            paymentData.reference = paymentData.reference || paymentData.ref || this.paymentReference;
                            paymentData.amount = paymentData.amount || payload.amount || (this.publicationFee * 100);
                            paymentData.email = paymentData.email || this.submission?.submitterEmail || '';
                            this.openPaystackModal(paymentData);
                            return;
                        }

                        // else redirect to authorization URL
                        if (this.paymentAuthorizationUrl) {
                            window.open(this.paymentAuthorizationUrl, '_blank');
                            const processingStatus = document.getElementById('processingStatus');
                            if (processingStatus) processingStatus.textContent = 'Waiting for payment confirmation...';
                            if (this.paymentReference) this.startPaymentVerification();
                            return;
                        }

                        throw new Error('Payment gateway did not return usable payment data.');
                    } catch (err) {
                        console.error('initiatePayment error:', err);
                        this.showPaymentError(err.message || 'Failed to initialize payment');
                        this.disableModalClose(false);
                        this.refreshOnClose = true;
                    }
                }

                openPaystackModal(paymentData) {
                    if (!paymentData || !window.PaystackPop) {
                        this.showPaymentError('Payment gateway not available');
                        this.disableModalClose(false);
                        this.refreshOnClose = true;
                        return;
                    }

                    const processingStatus = document.getElementById('processingStatus');
                    if (processingStatus) processingStatus.textContent = 'Opening payment popup...';

                    const publicKey = paymentData.publicKey || paymentData.key;
                    const amount = Number(paymentData.amount) || (this.publicationFee * 100);
                    const email = paymentData.email || this.submission?.submitterEmail || '';
                    const reference = paymentData.reference || paymentData.ref || this.paymentReference;

                    if (reference) this.paymentReference = reference;

                    try {
                        const handler = PaystackPop.setup({
                            key: publicKey,
                            email: email,
                            amount: amount,
                            ref: reference,
                            metadata: paymentData.metadata || {},
                            callback: (response) => {
                                console.log('Paystack callback response:', response);
                                const processingStatusAfter = document.getElementById('processingStatus');
                                if (processingStatusAfter) processingStatusAfter.textContent = 'Verifying payment...';

                                const ref = response.reference || response.trxref || response.tx_ref || response.ref;
                                if (ref) {
                                    this.paymentReference = ref;
                                    this.verifyPayment(ref);
                                } else {
                                    this.showPaymentError('No reference returned by Paystack');
                                    this.disableModalClose(false);
                                    this.refreshOnClose = true;
                                }
                            },
                            onClose: () => {
                                console.log('Paystack modal closed by user');
                                this.disableModalClose(false);
                                if (this.currentStep === 'processing') {
                                    this.showPaymentStep('confirmation');
                                    const processingStatusEl = document.getElementById('processingStatus');
                                    if (processingStatusEl) processingStatusEl.textContent = 'Initializing payment gateway...';
                                    toastr?.info('Payment cancelled. You can try again.');
                                }
                            }
                        });

                        handler.openIframe();
                    } catch (err) {
                        console.error('Paystack open error:', err);
                        this.showPaymentError('Failed to open payment popup');
                        this.disableModalClose(false);
                        this.refreshOnClose = true;
                    }
                }

                async verifyPayment(reference) {
                    if (!reference) {
                        this.showPaymentError('No payment reference provided');
                        this.disableModalClose(false);
                        this.refreshOnClose = true;
                        return;
                    }

                    try {
                        const token = getAuthToken2();
                        if (!token) {
                            this.showPaymentError('Authentication required for verification');
                            this.refreshOnClose = true;
                            return;
                        }

                        this.showPaymentStep('processing');
                        const processingStatus = document.getElementById('processingStatus');
                        if (processingStatus) processingStatus.textContent = 'Finalizing payment...';

                        // robust verify url using trxref
                        const base = String(BASE_URL).replace(/\/+$/, '');
                        const verifyBase = base.includes('/api/v1') ? base : `${base}/api/v1`;
                        const verifyUrl = `${verifyBase}/payments/verify?trxref=${encodeURIComponent(reference)}`;
                        console.log('verifyPayment ->', verifyUrl);

                        const res = await fetch(verifyUrl, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Accept': 'application/json'
                            }
                        });

                        const text = await res.text();
                        let data;
                        try { data = text ? JSON.parse(text) : {}; } catch (err) { throw new Error('Invalid verification response from server'); }

                        if (!res.ok) throw new Error(data.message || `Verification failed: ${res.status}`);

                        if (data.success) {
                            // capture DB id if backend returned it
                            this.paymentId = null;
                            if (data.payment && data.payment._id) this.paymentId = data.payment._id;
                            else if (data._id) this.paymentId = data._id;
                            else if (data.paymentId) this.paymentId = data.paymentId;
                            else if (data.data && data.data._id) this.paymentId = data.data._id;

                            console.log('Payment verified. reference=', reference, 'paymentId=', this.paymentId);

                            this.paymentData = data;
                            this.paymentReference = reference;
                            this.showPaymentSuccess(data);

                            if (this.verificationInterval) {
                                clearInterval(this.verificationInterval);
                                this.verificationInterval = null;
                            }

                            this.disableModalClose(false);
                            this.refreshOnClose = true;
                        } else {
                            const msg = data.message || 'Payment verification failed';
                            this.showPaymentError(msg, JSON.stringify(data));
                            this.disableModalClose(false);
                            this.refreshOnClose = true;
                        }
                    } catch (err) {
                        console.error('verifyPayment error:', err);
                        this.showPaymentError(err.message || 'Payment verification failed');
                        this.disableModalClose(false);
                        this.refreshOnClose = true;
                    }
                }

                startPaymentVerification() {
                    if (!this.paymentReference) return;
                    if (this.verificationInterval) clearInterval(this.verificationInterval);
                    this.verificationInterval = setInterval(async () => {
                        try {
                            await this.checkPaymentStatus();
                        } catch (e) {
                            console.error('polling error', e);
                        }
                    }, 5000);
                    setTimeout(() => this.checkPaymentStatus(), 1000);
                }

                async checkPaymentStatus() {
                    if (!this.paymentReference) return;
                    try {
                        const token = getAuthToken2();
                        if (!token) return;

                        // Use trxref parameter for polling too
                        const base = String(BASE_URL).replace(/\/+$/, '');
                        const verifyBase = base.includes('/api/v1') ? base : `${base}/api/v1`;
                        const verifyUrl = `${verifyBase}/payments/verify?trxref=${encodeURIComponent(this.paymentReference)}`;

                        const res = await fetch(verifyUrl, {
                            method: 'GET',
                            headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/json' }
                        });

                        if (!res.ok) return;
                        const data = await res.json();
                        if (data.success) {
                            clearInterval(this.verificationInterval);
                            this.showPaymentSuccess(data);
                            this.refreshOnClose = true;
                        } else {
                            console.log('verification pending or failed', data);
                        }
                    } catch (err) {
                        console.error('checkPaymentStatus error:', err);
                    }
                }

                showPaymentSuccess(paymentData) {
                    this.showPaymentStep('success');
                    const successReference = document.getElementById('successReference');
                    const successDate = document.getElementById('successDate');
                    if (successReference) successReference.textContent = this.paymentReference || (paymentData.reference || paymentData.ref || '');
                    if (successDate) successDate.textContent = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
                    this.paymentData = paymentData;
                    this.refreshOnClose = true;
                }

                showPaymentError(errorMessage, errorDetails = '') {
                    this.showPaymentStep('error');
                    const errorMessageEl = document.getElementById('errorMessage');
                    const errorDetailsEl = document.getElementById('errorDetails');
                    if (errorMessageEl) errorMessageEl.textContent = errorMessage;
                    if (errorDetailsEl && errorDetails) errorDetailsEl.innerHTML = `<p>${this.escapeHtml(errorDetails)}</p>`;
                    this.refreshOnClose = true;
                }

                closePaymentModal(forceClose = false) {
                    const paymentModal = document.getElementById('paymentModal');
                    if (!paymentModal) return;

                    if (this.currentStep === 'processing' && !forceClose) {
                        toastr?.warning('Please complete or cancel the payment process');
                        return;
                    }

                    paymentModal.classList.remove('active');
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';

                    // reset state so the modal can be re-opened without page reload
                    this.resetPaymentModal();

                    if (this.paymentTimer) { clearInterval(this.paymentTimer); this.paymentTimer = null; }
                    if (this.verificationInterval) { clearInterval(this.verificationInterval); this.verificationInterval = null; }

                    if (this.refreshOnClose) {
                        setTimeout(() => window.location.reload(), 300);
                    }
                }

                completePaymentProcess() {
                    this.closePaymentModal(true);
                }

                retryPayment() {
                    this.resetPaymentModal();
                    this.showPaymentStep('confirmation');
                }

                async viewReceipt() {
                    try {
                        if (this.paymentId) {
                            window.open(`payment-receipt.html?reference=${encodeURIComponent(this.paymentId)}`);
                            this.closePaymentModal(true);
                            return;
                        }

                        if (!this.paymentReference) {
                            toastr?.error('No payment reference found', 'Error');
                            return;
                        }

                        const token = getAuthToken2();
                        if (!token) {
                            toastr?.error('Authentication required', 'Error');
                            return;
                        }

                        const base = String(BASE_URL).replace(/\/+$/, '');
                        const verifyBase = base.includes('/api/v1') ? base : `${base}/api/v1`;
                        const verifyUrl = `${verifyBase}/payments/verify?trxref=${encodeURIComponent(this.paymentReference)}`;
                        console.log('Fetching payment record for receipt ->', verifyUrl);

                        const res = await fetch(verifyUrl, { method: 'GET', headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/json' } });
                        const text = await res.text();
                        let data;
                        try { data = text ? JSON.parse(text) : {}; } catch (err) { throw new Error('Invalid response while fetching payment record'); }

                        if (!res.ok || !data.success) {
                            const msg = data?.message || `Failed to fetch payment record (${res.status})`;
                            throw new Error(msg);
                        }

                        const paymentId = data.payment?._id || data._id || data.paymentId || (data.data && data.data._id) || null;
                        if (!paymentId) throw new Error('Payment record id not found in verification response');

                        this.paymentId = paymentId;
                        window.open(`/author/payment-receipt.html?id=${encodeURIComponent(paymentId)}`, '_blank');
                        this.closePaymentModal(true);
                    } catch (error) {
                        console.error('viewReceipt error:', error);
                        toastr?.error(error.message || 'Failed to open receipt', 'Error');
                    }
                }

                /* ---------- User/journal helpers and rendering ---------- */
                async getUserDetails(userId) {
                    if (!userId) return null;
                    if (this.userCache.has(userId)) return this.userCache.get(userId);
                    try {
                        const token = getAuthToken2();
                        if (!token) return null;
                        const response = await fetch(`${BASE_URL}/user/${userId}`, { method: 'GET', headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/json' } });
                        if (!response.ok) { console.warn(`Failed to fetch user ${userId}: ${response.status}`); return null; }
                        const data = await response.json();
                        if (!data.success) return null;
                        const user = data.user || data;
                        this.userCache.set(userId, user);
                        return user;
                    } catch (error) {
                        console.error(`Error fetching user ${userId}:`, error);
                        return null;
                    }
                }

                async getJournalDetails(journalId) {
                    if (!journalId) return null;
                    if (this.journalCache.has(journalId)) {
                        const journal = this.journalCache.get(journalId);
                        this.publicationFee = journal.publicationFee || this.publicationFee || 15000;
                        this.currency = journal.currency || this.currency || 'NGN';
                        return journal;
                    }
                    try {
                        const token = getAuthToken2();
                        if (!token) return null;
                        const response = await fetch(`${BASE_URL}/journal/${journalId}`, { method: 'GET', headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/json' } });
                        if (!response.ok) { console.warn(`Failed to fetch journal ${journalId}: ${response.status}`); return null; }
                        const data = await response.json();
                        if (!data.success) return null;
                        const journal = data.journal || data;
                        this.journalCache.set(journalId, journal);
                        this.publicationFee = journal.publicationFee || this.publicationFee || 15000;
                        this.currency = journal.currency || this.currency || 'NGN';
                        return journal;
                    } catch (error) {
                        console.error(`Error fetching journal ${journalId}:`, error);
                        return null;
                    }
                }

                renderManuscriptHeader() {
                    const header = document.getElementById('manuscriptHeader');
                    if (!header || !this.submission) return;
                    const formattedDate = this.formatDate(this.submission.createdAt || this.submission.created_at || this.submission.date);
                    const statusToDisplay = this.submission.currentStatus || this.submission.status || '';
                    const statusDisplay = this.formatStatus(statusToDisplay);
                    const journalName = this.submission.journalId?.title || this.submission.journalTitle || 'Unknown Journal';
                    const journalISSN = this.submission.journalId?.issn || 'N/A';
                    const submittedByName = this.submission.submitterName || 'Unknown';
                    header.innerHTML = `
            <h1>${this.escapeHtml(this.submission.title || 'Untitled')}</h1>
            <span class="header-status-badge">${this.escapeHtml(statusDisplay)}</span>
            <div class="header-meta">
                <div class="meta-item"><i class="fas fa-book-open"></i><span>Journal: ${this.escapeHtml(journalName)}</span></div>
                <div class="meta-item"><i class="fas fa-hashtag"></i><span>ISSN: ${this.escapeHtml(journalISSN)}</span></div>
                <div class="meta-item"><i class="fas fa-user"></i><span>Submitted by: ${this.escapeHtml(submittedByName)}</span></div>
                <div class="meta-item"><i class="far fa-calendar"></i><span>Submitted on: ${this.escapeHtml(formattedDate)}</span></div>
            </div>
        `;
                }

                renderAbstract() {
                    const abstractSection = document.getElementById('abstractSection');
                    const abstractContent = document.getElementById('abstractContent');
                    if (!abstractSection || !abstractContent || !this.submission) return;
                    const abstract = this.submission.abstract || '';
                    if (abstract && abstract.trim() !== '') {
                        abstractSection.style.display = 'block';
                        const processedAbstract = this.processContentForDisplay(abstract);
                        const isAbstractLong = processedAbstract.plainText.length > 300;
                        const abstractPreview = isAbstractLong ? processedAbstract.plainText.substring(0, 300) + '...' : processedAbstract.plainText;
                        const abstractDisplayHtml = isAbstractLong ? this.processContentForDisplay(abstractPreview).displayHtml : processedAbstract.displayHtml;
                        abstractContent.innerHTML = `
                <div class="abstract-text ${isAbstractLong ? 'truncated' : ''}">${abstractDisplayHtml}</div>
                ${isAbstractLong ? `<a class="view-more-link" onclick="authorManager.showFullContent('${this.escapeHtml(processedAbstract.displayHtml)}', 'abstract', 'Abstract')"><i class="fas fa-eye"></i> View full abstract</a>` : ''}
            `;
                    } else {
                        abstractSection.style.display = 'none';
                    }
                }

                renderAuthors() {
                    const authorsList = document.getElementById('authorsList');
                    if (!authorsList || !this.submission) return;
                    const authors = this.submission.authors || [];
                    if (authors.length === 0) {
                        authorsList.innerHTML = '<div class="no-authors">No authors listed</div>';
                        return;
                    }
                    authorsList.innerHTML = authors.map(author => `
            <div class="author-item"><div class="author-name">${this.escapeHtml(author.name)}</div><div class="author-email"><i class="fas fa-envelope"></i> ${this.escapeHtml(author.email)}</div></div>
        `).join('');
                }

                renderRevisions() {
                    const revisionsSection = document.getElementById('revisionsSection');
                    const revisionsContainer = document.getElementById('revisionsContainer');
                    const viewAllRevisionsBtn = document.getElementById('viewAllRevisionsBtn');
                    if (!revisionsSection || !revisionsContainer || !this.submission) return;
                    const status = this.submission.status || '';
                    const revisions = this.submission.revisions || [];
                    if (status === 'submitted' || revisions.length === 0) { revisionsSection.style.display = 'none'; return; }
                    revisionsSection.style.display = 'block';
                    if (viewAllRevisionsBtn && revisions.length > 0) viewAllRevisionsBtn.style.display = 'inline-flex';
                    if (revisions.length === 0) {
                        revisionsContainer.innerHTML = `<div class="no-revisions"><i class="fas fa-history"></i><h3>No Revisions Available</h3><p>No revisions have been submitted for this manuscript.</p></div>`;
                        return;
                    }
                    const sortedRevisions = [...revisions].sort((a, b) => (b.version || 0) - (a.version || 0));
                    let revisionsHTML = '<div class="revisions-grid">';
                    sortedRevisions.forEach(revision => {
                        const version = revision.version || 1;
                        const coverLetter = revision.coverLetter || '';
                        const changesSummary = revision.changesSummary || '';
                        const submittedAt = this.formatDate(revision.submittedAt || revision.createdAt, true);
                        const fileUrl = this.buildFileUrl(revision.file?.url || revision.file);
                        const processedCoverLetter = this.processContentForDisplay(coverLetter);
                        const isCoverLetterLong = processedCoverLetter.plainText.length > 100;
                        const coverLetterDisplayHtml = isCoverLetterLong ? this.processContentForDisplay(processedCoverLetter.plainText.substring(0, 100) + '...').displayHtml : processedCoverLetter.displayHtml;
                        const processedChangesSummary = this.processContentForDisplay(changesSummary);
                        const isChangesSummaryLong = processedChangesSummary.plainText.length > 100;
                        const changesSummaryDisplayHtml = isChangesSummaryLong ? this.processContentForDisplay(processedChangesSummary.plainText.substring(0, 100) + '...').displayHtml : processedChangesSummary.displayHtml;
                        revisionsHTML += `
                <div class="revision-card">
                    <div class="revision-header">
                        <div class="revision-title"><i class="fas fa-file-edit"></i> Revision ${version}</div>
                        <span class="revision-version">v${version}</span>
                    </div>
                    <div class="revision-content">
                        <div class="revision-item">
                            <div class="revision-label"><i class="fas fa-envelope"></i> Cover Letter</div>
                            <div class="revision-text ${isCoverLetterLong ? 'truncated' : ''}">${coverLetterDisplayHtml}</div>
                            ${isCoverLetterLong ? `<a class="view-more-link" onclick="authorManager.showFullContent('${this.escapeHtml(processedCoverLetter.displayHtml)}', 'cover-letter', 'Cover Letter - Revision ${version}')"><i class="fas fa-eye"></i> View full cover letter</a>` : ''}
                        </div>
                        <div class="revision-item">
                            <div class="revision-label"><i class="fas fa-list-check"></i> Changes Summary</div>
                            <div class="revision-text ${isChangesSummaryLong ? 'truncated' : ''}">${changesSummaryDisplayHtml}</div>
                            ${isChangesSummaryLong ? `<a class="view-more-link" onclick="authorManager.showFullContent('${this.escapeHtml(processedChangesSummary.displayHtml)}', 'changes-summary', 'Changes Summary - Revision ${version}')"><i class="fas fa-eye"></i> View full changes summary</a>` : ''}
                        </div>
                        <div class="revision-meta">
                            <div class="revision-date"><i class="far fa-calendar"></i> Submitted on: ${submittedAt}</div>
                            ${fileUrl ? `<a href="${fileUrl}" target="_blank" class="view-document-btn"><i class="fas fa-file-pdf"></i> View Document</a>` : '<span class="score-empty">No document</span>'}
                        </div>
                    </div>
                </div>
            `;
                    });
                    revisionsHTML += '</div>';
                    revisionsContainer.innerHTML = revisionsHTML;
                }

                processContentForDisplay(content) {
                    if (!content || content.trim() === '') return { plainText: '', displayHtml: '<span class="score-empty">No content</span>' };
                    const sanitizedHtml = this.sanitizeHTML(content);
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = sanitizedHtml;
                    const plainText = tempDiv.textContent || tempDiv.innerText || '';
                    return { plainText, displayHtml: sanitizedHtml };
                }

                sanitizeHTML(html) {
                    if (!html) return '';
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;
                    const scripts = tempDiv.querySelectorAll('script, style, link, meta, object, embed, iframe, frame');
                    scripts.forEach(s => s.remove());
                    const allowedTags = ['p', 'br', 'strong', 'b', 'em', 'i', 'u', 'ul', 'ol', 'li', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'a'];
                    const allElements = tempDiv.querySelectorAll('*');
                    allElements.forEach(el => {
                        if (!allowedTags.includes(el.tagName.toLowerCase())) {
                            const text = document.createTextNode(el.textContent);
                            el.parentNode.replaceChild(text, el);
                        } else {
                            if (el.tagName.toLowerCase() === 'a') {
                                const href = el.getAttribute('href');
                                el.removeAttribute('target'); el.removeAttribute('rel');
                                if (href && (/^https?:\/\//i.test(href) || href.startsWith('/'))) {
                                    el.setAttribute('href', href); el.setAttribute('target', '_blank'); el.setAttribute('rel', 'noopener noreferrer');
                                } else el.removeAttribute('href');
                            } else {
                                const attrs = Array.from(el.attributes); attrs.forEach(a => el.removeAttribute(a.name));
                            }
                        }
                    });
                    return tempDiv.innerHTML.trim() || html;
                }

                showFullContent(contentHtml, contentType, title) {
                    this.currentModalContent = contentHtml;
                    this.currentModalType = contentType;
                    this.currentModalTitle = title;
                    const modal = document.getElementById('contentModal');
                    const modalTitle = document.getElementById('contentModalTitle');
                    const modalType = document.getElementById('contentModalType');
                    const contentDisplay = document.getElementById('contentDisplay');
                    if (!modal || !modalTitle || !modalType || !contentDisplay) return;
                    modalTitle.textContent = title;
                    const typeMap = { 'cover-letter': 'Cover Letter', 'changes-summary': 'Changes Summary', 'abstract': 'Abstract', 'timeline-comment': 'Timeline Comment' };
                    modalType.textContent = typeMap[contentType] || 'Content';
                    contentDisplay.innerHTML = `<div class="content-display">${contentHtml || '<div class="empty">No content available</div>'}</div>`;
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                }

                closeContentModal() {
                    const modal = document.getElementById('contentModal');
                    if (modal) {
                        modal.style.display = 'none';
                        document.body.style.overflow = '';
                        this.currentModalContent = '';
                        this.currentModalType = '';
                        this.currentModalTitle = '';
                    }
                }

                async loadAssignedReviewers() {
                    const assignedReviewersSection = document.getElementById('assignedReviewersSection');
                    const assignedReviewersContainer = document.getElementById('assignedReviewers');
                    const reviewersCount = document.getElementById('reviewersCount');
                    if (!assignedReviewersSection || !assignedReviewersContainer || !this.submission) return;
                    const assignedReviewers = this.submission.assignedReviewers || [];
                    if (assignedReviewers.length === 0) { assignedReviewersSection.style.display = 'none'; return; }
                    assignedReviewersSection.style.display = 'block';
                    if (reviewersCount) reviewersCount.textContent = assignedReviewers.length;
                    const reviewerPromises = assignedReviewers.map(async (assignment) => {
                        const reviewerId = assignment.reviewerId; if (!reviewerId) return null;
                        const user = await this.getUserDetails(reviewerId); if (!user) return null;
                        return { ...assignment, name: `${user.firstName || ''} ${user.lastName || ''}`.trim() || 'Unknown Reviewer', email: user.email || '', hasReviewed: assignment.hasReviewed || false };
                    });
                    const reviewers = (await Promise.all(reviewerPromises)).filter(Boolean);
                    if (reviewers.length === 0) {
                        assignedReviewersContainer.innerHTML = `<div class="no-reviewers"><i class="fas fa-user-slash"></i><p>No reviewers information available</p></div>`;
                        return;
                    }
                    assignedReviewersContainer.innerHTML = reviewers.map(reviewer => `
            <div class="reviewer-card">
                <div class="reviewer-name">${this.escapeHtml(reviewer.name)}</div>
                <div class="reviewer-email"><i class="fas fa-envelope"></i> ${this.escapeHtml(reviewer.email)}</div>
                <div class="reviewer-status"><span class="status-indicator ${reviewer.hasReviewed ? 'completed' : 'pending'}"></span>${reviewer.hasReviewed ? 'Review completed' : 'Review pending'}</div>
            </div>
        `).join('');
                }

                setupFileActions() {
                    const viewBtn = document.getElementById('viewDocumentBtn');
                    const downloadBtn = document.getElementById('downloadBtn');
                    if (!viewBtn || !downloadBtn || !this.submission) return;
                    const fileUrl = this.submission.file?.url || this.submission.file;
                    if (!fileUrl) {
                        viewBtn.disabled = true; downloadBtn.disabled = true;
                        viewBtn.innerHTML = '<i class="fas fa-eye"></i> No Document Available';
                        downloadBtn.innerHTML = '<i class="fas fa-download"></i> No Document Available';
                        return;
                    }
                    const resolvedUrl = this.buildFileUrl(fileUrl);
                    const fileName = this.submission.file?.originalName || this.submission.title || 'manuscript';
                    viewBtn.addEventListener('click', () => window.open(resolvedUrl, '_blank'));
                    downloadBtn.addEventListener('click', () => {
                        const link = document.createElement('a'); link.href = resolvedUrl; link.download = fileName; document.body.appendChild(link); link.click(); document.body.removeChild(link);
                    });
                }

                buildFileUrl(filePath) {
                    if (!filePath) return null;
                    try {
                        const url = new URL(filePath);
                        return url.toString();
                    } catch {
                        return `${BASE_URL.replace('/api/v1', '')}${filePath}`;
                    }
                }

                async loadReviewDetails() {
                    try {
                        const token = getAuthToken2(); if (!token) return;
                        const response = await fetch(`${BASE_URL}/submissions/details/${this.submissionId}`, { method: 'GET', headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/json' } });
                        if (!response.ok) { console.warn('Failed to fetch review details:', response.status); return; }
                        const data = await response.json(); if (!data.success) return;
                        this.editorialDecision = data.editorialDecision || null;
                        this.reviewerFeedback = data.reviewerFeedback || null;
                        const reviewDetailsSection = document.getElementById('reviewDetailsSection');
                        const viewAllReviewsBtn = document.getElementById('viewAllReviewsBtn');
                        if (reviewDetailsSection) {
                            reviewDetailsSection.style.display = 'block';
                            if (viewAllReviewsBtn) viewAllReviewsBtn.style.display = 'inline-flex';
                            const revisionCount = data.submission?.revisionCount || this.submission?.revisionCount || 0;
                            const rvCountEl = document.getElementById('rvCount');
                            if (rvCountEl) rvCountEl.textContent = revisionCount;
                            const editorialDecisionCard = document.getElementById('editorialDecisionCard');
                            if (this.editorialDecision && editorialDecisionCard) {
                                editorialDecisionCard.style.display = 'block';
                                const decisionText = this.formatDecision(this.editorialDecision.decision);
                                const commentText = this.stripHtml(this.editorialDecision.comment || '');
                                const maxCharsForHeight = 120;
                                const isLongComment = commentText.length > maxCharsForHeight;
                                const commentPreview = isLongComment ? commentText.substring(0, maxCharsForHeight) + '...' : commentText;
                                const editorialDecisionDiv = document.getElementById('editorialDecision');
                                if (editorialDecisionDiv) {
                                    editorialDecisionDiv.innerHTML = `<div class="detail-content"><strong style="display:block; margin-bottom: 0.5rem;">${decisionText}</strong><div class="detail-value ${isLongComment ? 'truncated' : ''}">${this.escapeHtml(commentPreview)}</div></div>`;
                                    if (isLongComment) {
                                        const viewMoreBtn = document.createElement('button'); viewMoreBtn.className = 'view-more-btn'; viewMoreBtn.innerHTML = '<i class="fas fa-eye"></i> View in review details';
                                        viewMoreBtn.addEventListener('click', (e) => { e.preventDefault(); window.location.href = `author-review-details.html?id=${this.submissionId}`; });
                                        editorialDecisionDiv.appendChild(viewMoreBtn);
                                    }
                                }
                            }
                            const reviewerFeedbackCard = document.getElementById('reviewerFeedbackCard');
                            if (this.reviewerFeedback && reviewerFeedbackCard) {
                                reviewerFeedbackCard.style.display = 'block';
                                const reviewerFeedbackDiv = document.getElementById('reviewerFeedback');
                                if (this.reviewerFeedback.available && this.reviewerFeedback.reviews && this.reviewerFeedback.reviews.length > 0) {
                                    const review = this.reviewerFeedback.reviews[0];
                                    const recommendation = this.formatDecision(review.recommendation);
                                    const score = review.score || 'N/A';
                                    const date = this.formatDate(review.submittedAt, true);
                                    let reviewComment = ''; let isLongReview = false;
                                    if (review.comment) {
                                        const commentText = this.stripHtml(review.comment);
                                        const maxCharsForHeight = 80;
                                        isLongReview = commentText.length > maxCharsForHeight;
                                        reviewComment = isLongReview ? commentText.substring(0, maxCharsForHeight) + '...' : commentText;
                                    }
                                    if (reviewerFeedbackDiv) {
                                        reviewerFeedbackDiv.innerHTML = `<div class="detail-content"><strong style="display:block; margin-bottom: 0.25rem;">${recommendation}</strong>${reviewComment ? `<div class="detail-value ${isLongReview ? 'truncated' : ''}" style="margin-bottom: 0.5rem;">${this.escapeHtml(reviewComment)}</div>` : ''}<div style="color: var(--muted); font-size: 0.9rem;">Score: ${score}%  ${date}</div></div>`;
                                        if (isLongReview) {
                                            const viewMoreBtn = document.createElement('button'); viewMoreBtn.className = 'view-more-btn'; viewMoreBtn.innerHTML = '<i class="fas fa-eye"></i> View in review details';
                                            viewMoreBtn.addEventListener('click', (e) => { e.preventDefault(); window.location.href = `author-review-details.html?id=${this.submissionId}`; });
                                            reviewerFeedbackDiv.appendChild(viewMoreBtn);
                                        }
                                    }
                                } else if (reviewerFeedbackDiv) {
                                    reviewerFeedbackDiv.innerHTML = `<div class="detail-content"><div class="detail-value">No reviewer feedback available</div></div>`;
                                }
                            }
                        }
                        const status = this.submission?.currentStatus || this.submission?.status || '';
                        const revisedSection = document.getElementById('revisedSection');
                        if (status === 'revised' && revisedSection) {
                            revisedSection.style.display = 'block';
                            const revisionCount = data.submission?.revisionCount || this.submission?.revisionCount || 0;
                            document.getElementById('totalRevisions').textContent = revisionCount;
                            document.getElementById('revisionCountDisplay').textContent = `${revisionCount} revision${revisionCount !== 1 ? 's' : ''}`;
                            const latestRevision = this.submission.revisions?.[0]?.createdAt || this.submission.updatedAt || this.submission.createdAt;
                            if (latestRevision) document.getElementById('latestRevision').textContent = this.formatDate(latestRevision, true);
                        }
                    } catch (error) {
                        console.error('Error loading review details:', error);
                    }
                }

                async loadLatestTimelineEvent() {
                    try {
                        const token = getAuthToken2(); if (!token) return;
                        if (this.submission?.history && this.submission.history.length > 0) {
                            const latestEvent = this.submission.history[0];
                            await this.renderLatestTimelineEvent(latestEvent);
                            return;
                        }
                        const response = await fetch(`${BASE_URL}/submissions/${this.submissionId}/history`, { method: 'GET', headers: { 'Authorization': `Bearer ${token}`, 'Accept': 'application/json' } });
                        if (!response.ok) { console.warn(`Failed to fetch timeline: ${response.status}`); this.renderTimeline([]); return; }
                        const data = await response.json();
                        const timelineData = data.submission || data;
                        const history = timelineData.history || [];
                        const latestEvent = history.length > 0 ? history[0] : null;
                        if (latestEvent) await this.renderLatestTimelineEvent(latestEvent); else this.renderTimeline([]);
                    } catch (error) { console.error('Error loading timeline data:', error); this.renderTimeline([]); }
                }

                async renderLatestTimelineEvent(event) {
                    const timelineContainer = document.getElementById('recentTimeline'); if (!timelineContainer) return;
                    let updatedBy = 'System';
                    if (event.by) {
                        const user = await this.getUserDetails(event.by);
                        if (user) updatedBy = `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.email || 'Unknown User';
                    }
                    const processedComment = this.processContentForDisplay(event.comment || 'No comment provided');
                    const isCommentLong = processedComment.plainText.length > 150;
                    const commentPreview = isCommentLong ? processedComment.plainText.substring(0, 150) + '...' : processedComment.plainText;
                    const commentDisplayHtml = isCommentLong ? this.processContentForDisplay(commentPreview).displayHtml : processedComment.displayHtml;
                    timelineContainer.innerHTML = `
            <div class="timeline-item">
                <div class="card">
                    <span class="status-badge" style="${this.getStatusStyle(event.status)}">${this.formatStatus(event.status)}</span>
                    <p class="timeline-comment">${commentDisplayHtml}${isCommentLong ? `<a class="view-more-link" style="display:inline-block;margin-left:0.5rem;" onclick="authorManager.showFullContent('${this.escapeHtml(processedComment.displayHtml)}','timeline-comment','Timeline Comment - ${this.formatStatus(event.status)}')"><i class="fas fa-eye"></i> View full comment</a>` : ''}</p>
                    <p class="timeline-date"><i class="far fa-clock"></i> ${this.formatDate(event.date)}</p>
                    <div class="updated-by"><strong><i class="fas fa-user"></i> Updated by: ${this.escapeHtml(updatedBy)}</strong></div>
                </div>
            </div>
        `;
                }

                getStatusStyle(status) {
                    const colors = {
                        'submitted': 'background-color: #3b82f6; color: white;',
                        'under_review': 'background-color: #f59e0b; color: white;',
                        'reviewed': 'background-color: #8b5cf6; color: white;',
                        'accepted': 'background-color: #10b981; color: white;',
                        'rejected': 'background-color: #ef4444; color: white;',
                        'revised': 'background-color: #8b5cf6; color: white;',
                        'awaiting_payment': 'background-color: #f59e0b; color: white;',
                        'published': 'background-color: #10b981; color: white;'
                    };
                    return colors[status] || 'background-color: #6b7280; color: white;';
                }

                formatDecision(decision) {
                    if (!decision) return '';
                    const decisionMap = { 'accept': 'Accepted', 'reject': 'Rejected', 'minor_revision': 'Minor Revision Required', 'major_revision': 'Major Revision Required' };
                    return decisionMap[decision] || (decision.charAt(0).toUpperCase() + decision.slice(1)).replace(/_/g, ' ');
                }

                formatStatus(status) {
                    if (!status) return '';
                    const statusMap = { 'submitted': 'Submitted', 'under_review': 'Under Review', 'reviewed': 'Reviewed', 'accepted': 'Accepted', 'rejected': 'Rejected', 'revised': 'Revised', 'awaiting_payment': 'Awaiting Payment', 'published': 'Published', 'minor_revision': 'Minor Revision', 'major_revision': 'Major Revision', 'revision_requested': 'Revision Requested' };
                    return statusMap[status] || (status.charAt(0).toUpperCase() + status.slice(1)).replace(/_/g, ' ');
                }

                formatDate(dateString, dateOnly = false) {
                    try { if (!dateString) return ''; const date = new Date(dateString); if (dateOnly) return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }); return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' }); } catch (error) { return dateString; }
                }

                stripHtml(html) { if (!html) return ''; const div = document.createElement('div'); div.innerHTML = html; return div.textContent || div.innerText || ''; }
                renderTimeline(events) { const timelineContainer = document.getElementById('recentTimeline'); if (!timelineContainer) return; if (!events || events.length === 0) timelineContainer.innerHTML = '<div style="color: var(--muted); text-align: center; padding: 2rem;">No timeline events found</div>'; }
                showLoading() { const ls = document.getElementById('loadingScreen'); const es = document.getElementById('errorScreen'); const cc = document.getElementById('contentContainer'); if (ls) ls.style.display = 'block'; if (es) es.style.display = 'none'; if (cc) cc.style.display = 'none'; }
                hideLoading() { const ls = document.getElementById('loadingScreen'); if (ls) ls.style.display = 'none'; }
                showContent() { const cc = document.getElementById('contentContainer'); if (cc) cc.style.display = 'block'; }
                showError(message) { const ls = document.getElementById('loadingScreen'); const es = document.getElementById('errorScreen'); const cc = document.getElementById('contentContainer'); if (ls) ls.style.display = 'none'; if (es) es.style.display = 'block'; if (cc) cc.style.display = 'none'; const errMsg = document.getElementById('errorMessage'); if (errMsg) errMsg.textContent = message; }
                escapeHtml(str) { if (str === undefined || str === null) return ''; return String(str).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", "&#39;"); }
            }

            /* init */
            document.addEventListener('DOMContentLoaded', () => {
                const authorManager = new AuthorSubmissionDetailsManager();
                window.authorManager = authorManager;
            });

    </script>
</body>
<style>
    .reviewDetailsSection{
        display: none !important;
    }
</style>
</html>