<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Review Details</title>
    <script type="module" src="../assets/js/checkAuth.js"></script>
    <!-- Font Awesome (icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Toastr CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <!-- Global CSS (variables, body, main) -->
    <link rel="stylesheet" href="/assets/css/style.css">
    <!-- Header + Sidebar CSS -->
    <link rel="stylesheet" href="/assets/css/header_sidebar.css">

    <!-- Review Details CSS -->
    <style>
        :root {
            --bg: #f4f7fb;
            --card-bg: #ffffff;
            --accent: #4f46e5;
            --primary: var(--secondary-color2);
            --primary-light: rgba(255, 122, 24, 0.1);
            --primary-dark: #e56c0e;
            --muted: #6b7280;
            --light: #f8fafc;
            --border: #e2e8f0;
            --success: #10b981;
            --success-light: rgba(16, 185, 129, 0.1);
            --danger: #ef4444;
            --danger-light: rgba(239, 68, 68, 0.1);
            --warning: #f59e0b;
            --warning-light: rgba(245, 158, 11, 0.1);
            --info: #3b82f6;
            --info-light: rgba(59, 130, 246, 0.1);
            --radius: 12px;
            --card-shadow: 0 6px 20px rgba(22, 24, 46, 0.08);
            --card-shadow-hover: 0 18px 40px rgba(22, 24, 46, 0.12);
        }

        .review-details-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Back Button */
        .back-button-wrap {
            margin-bottom: 1.5rem;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--light);
            color: #374151;
            border: 1px solid var(--border);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            text-decoration: none;
        }

        .back-button:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
            transform: translateY(-1px);
        }

        /* Manuscript Header Card */
        .manuscript-header-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--card-shadow);
            padding: 2rem;
            margin-bottom: 2rem;
            border-left: 4px solid var(--primary);
            position: relative;
        }

        .manuscript-header-card h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 1rem;
            line-height: 1.3;
        }

        .header-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1.2rem;
            font-weight: 700;
            font-size: 0.85rem;
            border-radius: 20px;
            margin-bottom: 1rem;
            text-transform: capitalize;
        }

        .header-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
            margin-top: 1rem;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--muted);
            font-size: 0.95rem;
        }

        .meta-item i {
            color: var(--primary);
        }

        /* Content Sections */
        .content-section {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--card-shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .section-title i {
            color: var(--primary);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .count-badge {
            background: var(--primary-light);
            color: var(--primary);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* Authors Section */
        .authors-list {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .author-item {
            background: var(--light);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            min-width: 200px;
            flex: 1;
        }

        .author-name {
            font-weight: 600;
            color: #111827;
            margin-bottom: 0.25rem;
        }

        .author-email {
            color: var(--muted);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Revisions Section Styling (from submission details page) */
        .revisions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .revision-card {
            background: var(--light);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .revision-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--card-shadow-hover);
        }

        .revision-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--primary-light);
        }

        .revision-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .revision-version {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .revision-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .revision-item {
            margin-bottom: 0.75rem;
        }

        .revision-label {
            font-size: 0.9rem;
            color: var(--muted);
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .revision-text {
            font-size: 0.95rem;
            color: #374151;
            line-height: 1.5;
            margin: 0;
            word-wrap: break-word;
        }

        .revision-text.truncated {
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            max-height: 4.5em;
            position: relative;
        }

        .revision-text.truncated::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 30%;
            height: 1.5em;
            background: linear-gradient(to right, rgba(248, 250, 252, 0), var(--light) 50%);
        }

        .view-more-link {
            color: var(--info);
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            margin-top: 0.25rem;
            transition: color 0.2s;
        }

        .view-more-link:hover {
            color: #2563eb;
            text-decoration: underline;
        }

        .revision-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
            font-size: 0.85rem;
            color: var(--muted);
        }

        .revision-date {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .view-document-btn {
            background: var(--info);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .view-document-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .view-all-revisions-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            text-decoration: none;
            margin-top: 1rem;
        }

        .view-all-revisions-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .no-revisions {
            text-align: center;
            padding: 3rem;
            color: var(--muted);
        }

        .no-revisions i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* Manuscript File Section */
        .file-info-card {
            background: var(--light);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .file-details {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .file-icon {
            font-size: 2rem;
            color: var(--primary);
        }

        .file-text h3 {
            margin: 0 0 0.25rem 0;
            color: #111827;
            font-weight: 600;
        }

        .file-text p {
            margin: 0;
            color: var(--muted);
            font-size: 0.9rem;
        }

        .btn-light{
            max-height: 39px;
        }

        .btn-brand{
            height: 39px;
        } 

        /* Abstract Section Styling - Same as submission details page */
        .abstract-content {
            background: var(--light);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            line-height: 1.6;
            color: #374151;
        }

        .abstract-content p {
            margin: 0 0 1rem 0;
        }

        .abstract-content p:last-child {
            margin-bottom: 0;
        }

        .abstract-content .abstract-text {
            line-height: 1.6;
            color: #374151;
            word-wrap: break-word;
        }

        .abstract-content .abstract-text.truncated {
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 8;
            -webkit-box-orient: vertical;
            max-height: 12.8em;
            position: relative;
        }

        .abstract-content .abstract-text.truncated::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: 0;
            width: 30%;
            height: 1.6em;
            background: linear-gradient(to right, rgba(248, 250, 252, 0), var(--light) 50%);
        }

        .abstract-content .view-more-link {
            margin-top: 0.5rem;
            display: inline-block;
            color: var(--info);
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            transition: color 0.2s;
        }

        .abstract-content .view-more-link:hover {
            color: #2563eb;
            text-decoration: underline;
        }

        /* Decision Buttons Section */
        .decision-section {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px dashed var(--border);
            text-align: center;
            padding: 2.5rem 1.5rem;
        }

        .decision-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-weight: 700;
            font-size: 1rem;
            border-radius: 20px;
            margin-bottom: 1.5rem;
        }

        .decision-status-badge.accepted {
            background: var(--success-light);
            color: var(--success);
        }

        .decision-status-badge.declined {
            background: var(--danger-light);
            color: var(--danger);
        }

        .decision-status-badge.pending {
            background: var(--warning-light);
            color: var(--warning);
        }

        .decision-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1.5rem;
        }

        .btn-accept,
        .btn-decline {
            padding: 1rem 2rem;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1rem;
            min-width: 150px;
        }

        .btn-accept {
            background: var(--success);
            color: white;
        }

        .btn-accept:hover:not(:disabled) {
            background: #0da271;
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
        }

        .btn-decline {
            background: var(--danger);
            color: white;
        }

        .btn-decline:hover:not(:disabled) {
            background: #dc2626;
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(239, 68, 68, 0.3);
        }

        .btn-accept:disabled,
        .btn-decline:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Review Form Section */
        .review-form-section {
            display: none;
            /* Hidden by default, shown when accepted */
        }

        .review-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 600;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group label.required::after {
            content: "*";
            color: var(--danger);
            margin-left: 0.25rem;
        }

        .form-control {
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.2s;
            font-family: inherit;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 122, 24, 0.1);
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }

        .form-hint {
            color: var(--muted);
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        /* Recommendation Select */
        .recommendation-select {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .recommendation-option {
            position: relative;
        }

        .recommendation-option input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .recommendation-option label {
            display: block;
            padding: 1rem;
            background: var(--light);
            border: 2px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-weight: 600;
        }

        .recommendation-option input[type="radio"]:checked+label {
            background: var(--lite-secondary6);
            border-color: var(--primary);
            color: var(--primary);
        }

        .recommendation-option label:hover {
            border-color: var(--primary);
        }

        /* Score Input */
        .score-input-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .score-slider {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--border);
            border-radius: 3px;
            outline: none;
        }

        .score-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .score-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .score-display {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            min-width: 50px;
            text-align: center;
        }

        .score-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 0.25rem;
            color: var(--muted);
            font-size: 0.85rem;
        }

        /* Form Actions */
        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
        }

        .btn-submit-review {
            background: var(--success);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-submit-review:hover:not(:disabled) {
            background: #0da271;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-submit-review:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-reset {
            background: var(--light);
            color: var(--muted);
            border: 1px solid var(--border);
            padding: 1rem 2rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-reset:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
        }

        /* Timeline Section */
        .timeline-section {
            margin-top: 2rem;
        }

        .timeline-actions {
            margin-bottom: 1.5rem;
        }

        .btn-secondary {
            background: var(--light);
            color: var(--muted);
            border: 1px solid var(--border);
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
        }

        .timeline-item {
            position: relative;
            margin: 28px 0;
            display: block;
            padding-top: 2px;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.5s ease forwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -24px;
            top: 8px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--primary);
            box-shadow: 0 0 0 6px rgba(255, 122, 24, 0.1);
            z-index: 2;
        }

        .timeline-item .card {
            background: var(--card-bg);
            padding: 18px 20px;
            border-radius: var(--radius);
            box-shadow: var(--card-shadow);
            transition: transform .35s cubic-bezier(.16, .84, .24, 1), box-shadow .35s ease;
            will-change: transform;
            position: relative;
            min-height: 78px;
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .timeline-item .card:hover {
            transform: translateY(-8px);
            box-shadow: var(--card-shadow-hover);
        }

        .timeline-item .status-badge {
            width: fit-content;
            display: inline-block;
            padding: 0.28rem 1rem;
            font-weight: 700;
            font-size: 0.78rem;
            border-radius: 4px;
            margin-bottom: 12px;
            text-transform: capitalize;
        }

        /* Timeline comment styling - same as submission details page */
        .timeline-comment {
            font-size: 0.95rem;
            color: #374151 !important;
            line-height: 1.5;
            margin: 0.75rem 0;
            word-wrap: break-word;
        }

        .timeline-comment p {
            margin: 0 0 0.75rem 0;
            color: #374151;
        }

        .timeline-comment p:last-child {
            margin-bottom: 0;
        }

        .timeline-comment strong,
        .timeline-comment b {
            font-weight: 600;
            color: #111827;
        }

        .timeline-comment em,
        .timeline-comment i {
            font-style: italic;
        }

        .timeline-comment u {
            text-decoration: underline;
        }

        .timeline-comment ul,
        .timeline-comment ol {
            margin: 0 0 0.75rem 1.5rem;
            padding: 0;
        }

        .timeline-comment li {
            margin-bottom: 0.25rem;
            color: #374151;
        }

        .timeline-comment li:last-child {
            margin-bottom: 0;
        }

        .timeline-comment h1,
        .timeline-comment h2,
        .timeline-comment h3,
        .timeline-comment h4,
        .timeline-comment h5,
        .timeline-comment h6 {
            margin: 1rem 0 0.75rem 0;
            color: #111827;
            font-weight: 600;
        }

        .timeline-comment h1 {
            font-size: 1.4rem;
        }

        .timeline-comment h2 {
            font-size: 1.2rem;
        }

        .timeline-comment h3 {
            font-size: 1.1rem;
        }

        .timeline-comment .view-more-link {
            display: inline-block;
            margin-left: 0.5rem;
            color: var(--info);
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            transition: color 0.2s;
        }

        .timeline-comment .view-more-link:hover {
            color: #2563eb;
            text-decoration: underline;
        }

        .timeline-date {
            font-size: 0.8rem;
            color: var(--muted);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .updated-by {
            font-size: 0.85rem;
            color: var(--muted);
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }

        .updated-by strong {
            color: #374151;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Content Modal Styles - Same as submission details page */
        .content-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .content-modal .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .content-modal .modal-content {
            position: relative;
            z-index: 10001;
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--card-shadow-hover);
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .content-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .content-modal-header h3 {
            margin: 0;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-content-type {
            font-size: 0.9rem;
            color: var(--muted);
            margin-top: 0.25rem;
            font-weight: normal;
        }

        .content-modal-body {
            padding: 1.5rem;
            max-height: 60vh;
            overflow-y: auto;
        }

        .content-display {
            line-height: 1.6;
            color: #374151;
            word-wrap: break-word;
        }

        .content-display p {
            margin: 0 0 1rem 0;
        }

        .content-display p:last-child {
            margin-bottom: 0;
        }

        .content-display strong,
        .content-display b {
            font-weight: 600;
        }

        .content-display em,
        .content-display i {
            font-style: italic;
        }

        .content-display u {
            text-decoration: underline;
        }

        .content-display ul,
        .content-display ol {
            margin: 0 0 1rem 1.5rem;
            padding: 0;
        }

        .content-display li {
            margin-bottom: 0.5rem;
        }

        .content-display li:last-child {
            margin-bottom: 0;
        }

        .content-display h1,
        .content-display h2,
        .content-display h3,
        .content-display h4,
        .content-display h5,
        .content-display h6 {
            margin: 1.5rem 0 1rem 0;
            color: #111827;
            font-weight: 600;
        }

        .content-display h1 {
            font-size: 1.8rem;
        }

        .content-display h2 {
            font-size: 1.5rem;
        }

        .content-display h3 {
            font-size: 1.3rem;
        }

        .content-display h4 {
            font-size: 1.1rem;
        }

        .content-display h5 {
            font-size: 1rem;
        }

        .content-display h6 {
            font-size: 0.9rem;
        }

        .fa-file-pdf{
            color: var(--danger);
        }

        /* Review Submitted Message */
        .review-submitted-message {
            background: linear-gradient(135deg, #FEFDFD 0%, #83B4CE 100%);
            border: 2px solid var(--lite-secondary3);
            border-radius: var(--radius);
            padding: 2rem;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .review-submitted-message i {
            font-size: 3rem;
            color: var(--lite-secondary1);
            margin-bottom: 1rem;
        }

        .review-submitted-message h3 {
            color: var(--lite-secondary1);
            margin-bottom: 0.5rem;
        }

        .review-submitted-message p {
            color: var(--lite-secondary1);
            margin-bottom: 0;
        }

        /* Loading and Error States */
        .loading-screen {
            text-align: center;
            padding: 3rem;
            color: var(--muted);
        }

        .loading-screen .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error-screen {
            text-align: center;
            padding: 3rem;
            color: var(--muted);
        }

        .error-screen i {
            color: var(--danger);
            margin-bottom: 1rem;
        }

        .error-screen h3 {
            color: #111827;
            margin-bottom: 0.5rem;
        }

        .retry-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 1rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .retry-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        /* Editors Section */
        .editors-list {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .editor-category {
            flex: 1;
            min-width: 300px;
        }

        .editor-category h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-light);
        }

        .editor-item {
            background: var(--light);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .editor-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--card-shadow);
        }

        .editor-name {
            font-weight: 600;
            color: #111827;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .editor-email {
            color: var(--muted);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .editor-role {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--warning-light);
            color: var(--warning);
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        /* Rich Text Editor Styles */
        .editor-toolbar {
            display: flex;
            gap: 5px;
            padding: 8px;
            background: #f8f9fa;
            border-top-left-radius: 6px;
            border-top-right-radius: 6px;
            border: 1px solid var(--border);
            border-bottom: none;
        }

        .editor-toolbar .format-btn {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 14px;
            color: #495057;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .editor-toolbar .format-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .editor-toolbar .format-btn.active {
            background: var(--primary-light);
            color: var(--primary);
            border-color: var(--primary);
        }

        .editor-content {
            min-height: 120px;
            padding: 12px;
            border: 1px solid var(--border);
            border-top: none;
            border-bottom-left-radius: 6px;
            border-bottom-right-radius: 6px;
            outline: none;
            max-height: 400px;
            overflow-y: auto;
            background: white;
        }

        .editor-content:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 122, 24, 0.1);
        }

        .editor-content p {
            margin: 0 0 10px 0;
        }

        .editor-content ul,
        .editor-content ol {
            margin: 0 0 10px 20px;
            padding: 0;
        }

        .editor-content li {
            margin-bottom: 5px;
        }

        .editor-content blockquote {
            border-left: 4px solid var(--primary);
            margin: 10px 0;
            padding-left: 15px;
            color: #6c757d;
            font-style: italic;
        }

        .editor-content h1,
        .editor-content h2,
        .editor-content h3,
        .editor-content h4,
        .editor-content h5,
        .editor-content h6 {
            margin: 15px 0 10px 0;
            color: #212529;
        }

        .editor-content h3 {
            font-size: 1.3rem;
            font-weight: 600;
        }

        /* File Upload Styles */
        .file-upload-group {
            border: 2px dashed var(--lite-secondary4);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            background: var(--light);
            transition: all 0.3s;
        }

        .file-upload-group:hover {
            background: var(--lite-secondary6);
        }

        .file-upload-group.drag-over {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .file-input-hidden {
            display: none;
        }

        .file-upload-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
        }

        .file-upload-icon {
            font-size: 2.5rem;
            color: var(--primary);
        }

        .file-upload-text h4 {
            margin: 0 0 0.5rem 0;
            color: #111827;
            font-weight: 600;
        }

        .file-upload-text p {
            margin: 0;
            color: var(--muted);
            font-size: 0.9rem;
        }

        .file-preview {
            margin-top: 1rem;
            display: none;
        }

        .file-preview.show {
            display: block;
        }

        .file-preview-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 1rem;
            margin-top: 0.5rem;
        }

        .file-preview-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .file-preview-icon {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .file-preview-name {
            font-weight: 600;
            color: #111827;
        }

        .file-preview-size {
            color: var(--muted);
            font-size: 0.85rem;
        }

        .remove-file-btn {
            background: var(--danger-light);
            color: var(--danger);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .remove-file-btn:hover {
            background: var(--danger);
            color: white;
        }

        .file-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
        }

        .skeleton-icon {
            background: #f0f0f0;
            border-radius: 50%;
        }

        @keyframes loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .review-details-container {
                padding: 0 0.5rem;
            }

            .manuscript-header-card {
                padding: 1.5rem;
            }

            .manuscript-header-card h1 {
                font-size: 1.5rem;
            }

            .header-meta {
                flex-direction: column;
                gap: 1rem;
            }

            .content-section {
                padding: 1rem;
            }

            .decision-buttons {
                flex-direction: column;
            }

            .btn-accept,
            .btn-decline {
                width: 100%;
                justify-content: center;
            }

            .author-item {
                min-width: 100%;
            }

            .file-info-card {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

      
            .btn-download,
            .btn-light {
                width: 100%;
                justify-content: center;
            }

            .recommendation-select {
                grid-template-columns: 1fr;
            }

            .form-actions {
                flex-direction: column;
            }

            .btn-submit-review,
            .btn-reset {
                width: 100%;
                justify-content: center;
            }

            .content-modal .modal-content {
                width: 95%;
                max-height: 90vh;
            }

            /* Revisions section responsive */
            .revisions-grid {
                grid-template-columns: 1fr;
            }

            .revision-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }

            .revision-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }

            .view-document-btn {
                width: 100%;
                justify-content: center;
            }

            .view-all-revisions-btn {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .revision-card {
                padding: 1rem;
            }

            .content-modal-body {
                padding: 1rem;
            }
        }
    </style>
</head>

<body>
    <div class="dashboard-container">
        <!-- placeholders for partials -->
        <div id="sidebar-placeholder"></div>
        <div class="main-content-wrapper">
            <div id="header-placeholder"></div>

            <main class="main-content">
                <!-- Back Button -->
                <div class="back-button-wrap">
                    <a href="reviews.html" class="back-button">
                        <i class="fas fa-arrow-left"></i>Back to Reviews
                    </a>
                </div>

                <div class="review-details-container">
                    <!-- Manuscript Header Card -->
                    <div id="manuscriptHeader" class="manuscript-header-card">
                        <!-- Skeleton Loading -->
                        <div class="skeleton" style="height: 32px; width: 70%; margin-bottom: 1rem;"></div>
                        <div class="skeleton" style="height: 28px; width: 40%; margin-bottom: 1rem;"></div>
                        <div class="header-meta">
                            <div class="meta-item">
                                <div class="skeleton-icon" style="width: 16px; height: 16px; min-width: 16px;"></div>
                                <div class="skeleton" style="height: 20px; width: 150px;"></div>
                            </div>
                            <div class="meta-item">
                                <div class="skeleton-icon" style="width: 16px; height: 16px; min-width: 16px;"></div>
                                <div class="skeleton" style="height: 20px; width: 180px;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Loading Screen -->
                    <div id="loadingScreen" class="loading-screen">
                        <div class="spinner"></div>
                        <p>Loading review details...</p>
                    </div>

                    <!-- Error Screen -->
                    <div id="errorScreen" class="error-screen" style="display: none;">
                        <i class="fas fa-exclamation-triangle fa-3x"></i>
                        <h3>Failed to load review</h3>
                        <p id="errorMessage">An error occurred while loading the review.</p>
                        <button class="retry-btn" onclick="window.location.reload()">
                            <i class="fas fa-redo"></i> Try Again
                        </button>
                    </div>

                    <!-- Content (hidden until loaded) -->
                    <div id="contentContainer" style="display: none;">
                    <!-- Manuscript File Section -->
                    <div class="content-section">
                        <h2 class="section-title">
                            <i class="fas fa-file-alt"></i> Manuscript Document
                        </h2>
                        <div id="fileInfoCard" class="file-info-card">
                            <div class="file-details">
                                <div class="file-icon">
                                    <i class="fas fa-file-word"></i>
                                </div>
                                <div class="file-text">
                                    <h3 id="fileName">Loading...</h3>
                                    <p id="fileSize">Original file: loading...</p>
                                </div>
                            </div>
                            <div class="file-actions">
                                <a id="viewDocumentLink" class="btn-light" href="#" target="_blank">
                                    <i class="fas fa-external-link-alt"></i> View Document
                                </a>
                                <button id="downloadDocumentBtn" class="btn-brand">
                                    <i class="fas fa-download"></i> Download
                                </button>
                            </div>
                        </div>
                    </div>

                        <!-- Abstract Section -->
                        <div class="content-section">
                            <h2 class="section-title">
                                <i class="fas fa-align-left"></i> Abstract
                            </h2>
                            <div id="abstractContent" class="abstract-content">
                                <!-- Abstract will be populated here -->
                            </div>
                        </div>

                        <!-- Authors Section -->
                        <div class="content-section" style="display: none !important;">
                            <div class="section-header">
                                <h2 class="section-title">
                                    <i class="fas fa-users"></i> Authors
                                </h2>
                                <span id="authorsCount" class="count-badge">0</span>
                            </div>
                            <div id="authorsList" class="authors-list">
                                <!-- Authors will be populated here -->
                            </div>
                        </div>

                        <!-- Editors Section -->
                        <div id="editorsSection" class="content-section" style="display: 
                        none !important;">
                            <div class="section-header">
                                <h2 class="section-title">
                                    <i class="fas fa-user-edit"></i> Editors
                                </h2>
                                <span id="editorsCount" class="count-badge">0</span>
                            </div>
                            <div id="editorsList" class="editors-list">
                                <!-- Editors will be populated here -->
                            </div>
                        </div>

                        <!-- Revisions Section -->
                        <div id="revisionsSection" class="content-section" style="display: none;">
                            <div class="section-header">
                                <h2 class="section-title">
                                    <i class="fas fa-history"></i> Revisions
                                </h2>
                                <button id="viewAllRevisionsBtn" class="view-all-revisions-btn" style="display: none;">
                                    <i class="fas fa-external-link-alt"></i> View All Revisions
                                </button>
                            </div>
                            <div id="revisionsContainer">
                                <!-- Revisions will be populated here -->
                            </div>
                        </div>

                        <!-- Decision Section -->
                        <div class="content-section decision-section">
                            <h2 class="section-title">
                                <i class="fas fa-clipboard-check"></i> Review Invitation
                            </h2>

                            <!-- Decision Status Badge -->
                            <div id="decisionStatusBadge" class="decision-status-badge pending">
                                <i class="fas fa-clock"></i>
                                <span>Pending Your Response</span>
                            </div>

                            <!-- Decision Buttons -->
                            <div id="decisionButtons" class="decision-buttons">
                                <button id="acceptBtn" class="btn-accept">
                                    <i class="fas fa-check-circle"></i> Accept Review
                                </button>
                                <button id="declineBtn" class="btn-decline">
                                    <i class="fas fa-times-circle"></i> Decline Review
                                </button>
                            </div>

                            <div id="decisionMessage" class="form-hint" style="margin-top: 1rem; text-align: center;">
                                <!-- Decision messages will appear here -->
                            </div>
                        </div>

                        <!-- Review Submitted Message (shown when manuscript is no longer under_review) -->
                        <div id="reviewSubmittedMessage" class="review-submitted-message" style="display: none;">
                            <i class="fas fa-check-circle"></i>
                            <h3>Review Submitted Successfully</h3>
                            <p>Thank you for completing your review. The editor has been notified.</p>
                        </div>

                        <!-- Review Form Section -->
                        <div id="reviewFormSection" class="content-section review-form-section">
                            <h2 class="section-title">
                                <i class="fas fa-edit"></i> Submit Your Review
                            </h2>

                            <form id="reviewForm" class="review-form">
                        <!-- Comments to Editor -->
                        <div class="form-group">
                            <label for="commentsToEditor" class="required">
                                <i class="fas fa-comment-dots"></i> Confidential Comments to Editor
                            </label>

                            <!-- Rich text editor toolbar -->
                            <div id="editorToolbar" class="editor-toolbar" style="background: #f8f9fa; padding: 8px; border-bottom: 1px solid #dee2e6;">
                                <button type="button" class="format-btn" data-command="bold" title="Bold">
                                    <i class="fas fa-bold"></i>
                                </button>
                                <button type="button" class="format-btn" data-command="italic" title="Italic">
                                    <i class="fas fa-italic"></i>
                                </button>
                                <button type="button" class="format-btn" data-command="underline" title="Underline">
                                    <i class="fas fa-underline"></i>
                                </button>
                                <span style="margin: 0 10px; color: #dee2e6;">|</span>
                                <button type="button" class="format-btn" data-command="insertUnorderedList" title="Bullet List">
                                    <i class="fas fa-list-ul"></i>
                                </button>
                                <button type="button" class="format-btn" data-command="insertOrderedList" title="Numbered List">
                                    <i class="fas fa-list-ol"></i>
                                </button>
                                <span style="margin: 0 10px; color: #dee2e6;">|</span>
                                <button type="button" class="format-btn" data-command="formatBlock" data-value="<h3>" title="Heading">
                                    <i class="fas fa-heading"></i>
                                </button>
                                <button type="button" class="format-btn" data-command="insertHTML" data-value="<blockquote>" title="Quote">
                                    <i class="fas fa-quote-right"></i>
                                </button>
                            </div>

                            <textarea id="commentsToEditor" name="commentsToEditor" class="form-control" placeholder="Provide confidential feedback for the editor only..." required></textarea>
                            <div class="form-hint">
                                These comments will only be visible to the editor, not the authors.
                            </div>
                        </div>

                        <!-- Comments to Author -->
                        <div class="form-group">
                            <label for="commentsToAuthor" class="required">
                                <i class="fas fa-comments"></i> Comments to Author
                            </label>

                            <!-- Rich text editor toolbar -->
                            <div id="authorToolbar" class="editor-toolbar" style="background: #f8f9fa; padding: 8px; border-bottom: 1px solid #dee2e6;">
                                <button type="button" class="format-btn" data-command="bold" title="Bold">
                                    <i class="fas fa-bold"></i>
                                </button>
                                <button type="button" class="format-btn" data-command="italic" title="Italic">
                                    <i class="fas fa-italic"></i>
                                </button>
                                <button type="button" class="format-btn" data-command="underline" title="Underline">
                                    <i class="fas fa-underline"></i>
                                </button>
                                <span style="margin: 0 10px; color: #dee2e6;">|</span>
                                <button type="button" class="format-btn" data-command="insertUnorderedList" title="Bullet List">
                                    <i class="fas fa-list-ul"></i>
                                </button>
                                <button type="button" class="format-btn" data-command="insertOrderedList" title="Numbered List">
                                    <i class="fas fa-list-ol"></i>
                                </button>
                                <span style="margin: 0 10px; color: #dee2e6;">|</span>
                                <button type="button" class="format-btn" data-command="formatBlock" data-value="<h3>" title="Heading">
                                    <i class="fas fa-heading"></i>
                                </button>
                                <button type="button" class="format-btn" data-command="insertHTML" data-value="<blockquote>" title="Quote">
                                    <i class="fas fa-quote-right"></i>
                                </button>
                            </div>

                            <textarea id="commentsToAuthor" name="commentsToAuthor" class="form-control" placeholder="Provide constructive feedback for the authors..." required></textarea>
                            <div class="form-hint">
                                These comments will be shared with the manuscript authors.
                            </div>
                        </div>

                                <!-- Recommendation -->
                                <div class="form-group">
                                    <label class="required">
                                        <i class="fas fa-star"></i> Recommendation
                                    </label>
                                    <div class="recommendation-select">
                                        <div class="recommendation-option">
                                            <input type="radio" id="accept" name="recommendation" value="accept">
                                            <label for="accept">Accept</label>
                                        </div>
                                        <div class="recommendation-option">
                                            <input type="radio" id="minor_revision" name="recommendation" value="minor_revision">
                                            <label for="minor_revision">Minor Revision</label>
                                        </div>
                                        <div class="recommendation-option">
                                            <input type="radio" id="major_revision" name="recommendation" value="major_revision">
                                            <label for="major_revision">Major Revision</label>
                                        </div>
                                        <div class="recommendation-option">
                                            <input type="radio" id="reject" name="recommendation" value="reject">
                                            <label for="reject">Reject</label>
                                        </div>
                                    </div>
                                    <div class="form-hint">
                                        Select your recommendation for this manuscript.
                                    </div>
                                </div>

                                <!-- Score -->
                                <div class="form-group">
                                    <label for="score" class="required">
                                        <i class="fas fa-chart-line"></i> Overall Score
                                    </label>
                                    <div class="score-input-container">
                                        <input type="range" id="score" name="score" min="0" max="100" value="50" class="score-slider">
                                        <div id="scoreDisplay" class="score-display">50</div>
                                    </div>
                                    <div class="score-labels">
                                        <span>Poor (0)</span>
                                        <span>Excellent (100)</span>
                                    </div>
                                    <div class="form-hint">
                                        Rate the overall quality of the manuscript.
                                    </div>
                                </div>

                                <!-- File Upload -->
                                <div class="form-group">
                                    <label>
                                        <i class="fas fa-paperclip"></i> Review Attachment (Optional)
                                    </label>
                                    <div id="fileUploadArea" class="file-upload-group">
                                        <input type="file" id="reviewFile" name="reviewFile" class="file-input-hidden" accept=".pdf,.doc,.docx">
                                        <label for="reviewFile" class="file-upload-label">
                                            <div class="file-upload-icon">
                                                <i class="fas fa-cloud-upload-alt"></i>
                                            </div>
                                            <div class="file-upload-text">
                                                <h4>Click to upload or drag and drop</h4>
                                                <p>PDF or Word documents only (Max: 10MB)</p>
                                            </div>
                                        </label>
                                    </div>
                                    <div id="filePreview" class="file-preview">
                                        <div class="file-preview-item">
                                            <div class="file-preview-info">
                                                <div class="file-preview-icon">
                                                    <i class="fas fa-file-pdf"></i>
                                                </div>
                                                <div>
                                                    <div id="fileNamePreview" class="file-preview-name"></div>
                                                    <div id="fileSizePreview" class="file-preview-size"></div>
                                                </div>
                                            </div>
                                            <button type="button" id="removeFileBtn" class="remove-file-btn">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="form-hint">
                                        Optional: Attach your review comments as a separate file.
                                    </div>
                                </div>

                                <!-- Form Actions -->
                                <div class="form-actions">
                                    <button type="button" id="resetFormBtn" class="btn-clear">
                                        <i class="fas fa-redo"></i> Reset Form
                                    </button>
                                    <button type="submit" id="submitReviewBtn" class="btn-brand">
                                        <i class="fas fa-paper-plane"></i> Submit Review
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Timeline Section -->
                        <div class="content-section timeline-section">
                            <h2 class="section-title">
                                <i class="fas fa-history"></i> Manuscript Timeline
                            </h2>
                            <div class="timeline-actions">
                                <button id="viewTimelineBtn" class="btn-secondary">
                                    <i class="fas fa-external-link-alt"></i> View Full Timeline
                                </button>
                            </div>
                            <div id="recentTimeline" class="recent-timeline">
                                <!-- Most recent timeline event will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Content Display Modal - Same as submission details page -->
    <div id="contentModal" class="modal content-modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="content-modal-header">
                <div>
                    <h3 id="contentModalTitle">Content Details</h3>
                    <div id="contentModalType" class="modal-content-type"></div>
                </div>
                <button class="modal-close" id="closeContentModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="content-modal-body">
                <div id="contentDisplay" class="content-display">
                    <!-- Content will be displayed here -->
                </div>
            </div>
        </div>
    </div>search-button

    <script>
        window.SIDEBAR_MODULE = 'reviewer';
        window.SIDEBAR_ACTIVE_ID = 'assigned-reviews';
    </script>
    <script src="/assets/js/layout.js"></script>
    <!-- jQuery (for toastr) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Toastr -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script type="module">
    import { BASE_URL, token, apiFetch } from '/assets/js/utility.js';

    class ReviewDetailsManager {
        constructor() {
            this.reviewId = this.getReviewIdFromURL();
            this.review = null;
            this.userCache = new Map();
            this.currentModalContent = '';
            this.currentModalType = '';
            this.currentModalTitle = '';
            this.selectedFile = null;
            this.isFileSelectionActive = false; // NEW: Track file selection state

            if (!this.reviewId) {
                this.showError('No review ID provided');
                return;
            }

            this.initializeToastr();
            this.bindEvents();
            this.initialize();
        }

        getReviewIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id');
        }

        initializeToastr() {
            toastr.options = {
                closeButton: false,
                progressBar: false,
                positionClass: "toast-top-right",
                timeOut: 3000,
                extendedTimeOut: 1000
            };
        }

        bindEvents() {
            // Content modal close button
            document.getElementById('closeContentModal')?.addEventListener('click', () => {
                this.closeContentModal();
            });

            // Close modal when clicking outside
            document.getElementById('contentModal')?.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    this.closeContentModal();
                }
            });

            // Close modal with Escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    this.closeContentModal();
                }
            });

            setTimeout(() => {
                // Decision buttons
                document.getElementById('acceptBtn')?.addEventListener('click', () => this.respondToInvitation('accept'));
                document.getElementById('declineBtn')?.addEventListener('click', () => this.respondToInvitation('decline'));

                // Review form
                document.getElementById('score')?.addEventListener('input', (e) => {
                    document.getElementById('scoreDisplay').textContent = e.target.value;
                });

                document.getElementById('resetFormBtn')?.addEventListener('click', () => this.resetForm());

                // File upload - FIXED: Prevent multiple file selector openings
                const fileInput = document.getElementById('reviewFile');
                const fileUploadArea = document.getElementById('fileUploadArea');

                if (fileInput) {
                    fileInput.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent event bubbling
                    });

                    fileInput.addEventListener('change', (e) => {
                        if (!this.isFileSelectionActive) {
                            this.isFileSelectionActive = true;
                            this.handleFileSelect(e);
                            // Reset the flag after a short delay
                            setTimeout(() => {
                                this.isFileSelectionActive = false;
                            }, 100);
                        }
                    });
                }

                if (fileUploadArea) {
                    // Remove the direct click event that was causing the issue
                    // Only use the label's natural behavior

                    // Drag and drop events
                    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                        fileUploadArea.addEventListener(eventName, (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                        });
                    });

                    ['dragenter', 'dragover'].forEach(eventName => {
                        fileUploadArea.addEventListener(eventName, () => {
                            fileUploadArea.classList.add('drag-over');
                        });
                    });

                    ['dragleave', 'drop'].forEach(eventName => {
                        fileUploadArea.addEventListener(eventName, () => {
                            fileUploadArea.classList.remove('drag-over');
                        });
                    });

                    fileUploadArea.addEventListener('drop', (e) => {
                        const files = e.dataTransfer.files;
                        if (files.length > 0 && !this.isFileSelectionActive) {
                            this.isFileSelectionActive = true;
                            this.handleFileSelect({ target: { files } });
                            setTimeout(() => {
                                this.isFileSelectionActive = false;
                            }, 100);
                        }
                    });
                }

                // Remove file button
                document.getElementById('removeFileBtn')?.addEventListener('click', () => {
                    this.removeSelectedFile();
                });

                // Form submission
                const reviewForm = document.getElementById('reviewForm');
                if (reviewForm) {
                    reviewForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.submitReview();
                    });
                }

                // View Full Timeline button
                document.getElementById('viewTimelineBtn')?.addEventListener('click', () => {
                    window.location.href = `review-timeline.html?id=${this.review?.manuscript?._id || this.reviewId}`;
                });

                // View All Revisions button
                document.getElementById('viewAllRevisionsBtn')?.addEventListener('click', () => {
                    if (this.review?.manuscript?._id) {
                        window.location.href = `revision-history.html?id=${this.review.manuscript._id}`;
                    }
                });

                // Download document button
                document.getElementById('downloadDocumentBtn')?.addEventListener('click', () => {
                    this.downloadDocument();
                });

                // Initialize rich text editors
                this.initializeRichTextEditors();
            }, 100);
        }

        initializeRichTextEditors() {
            // Initialize for comments to editor
            const editorToolbar = document.getElementById('editorToolbar');
            const commentsToEditor = document.getElementById('commentsToEditor');

            if (editorToolbar && commentsToEditor) {
                this.setupRichTextEditor(editorToolbar, commentsToEditor);
            }

            // Initialize for comments to author
            const authorToolbar = document.getElementById('authorToolbar');
            const commentsToAuthor = document.getElementById('commentsToAuthor');

            if (authorToolbar && commentsToAuthor) {
                this.setupRichTextEditor(authorToolbar, commentsToAuthor);
            }
        }

        setupRichTextEditor(toolbar, textarea) {
            // Create editor container
            const editorContainer = document.createElement('div');
            editorContainer.className = 'rich-text-editor';
            editorContainer.style.border = '1px solid var(--border)';
            editorContainer.style.borderRadius = '6px';
            editorContainer.style.overflow = 'hidden';

            // Create editor content area
            const editorContent = document.createElement('div');
            editorContent.className = 'editor-content';
            editorContent.style.minHeight = '120px';
            editorContent.style.padding = '12px';
            editorContent.style.outline = 'none';
            editorContent.style.maxHeight = '400px';
            editorContent.style.overflowY = 'auto';
            editorContent.contentEditable = true;

            // Set initial content from textarea
            editorContent.innerHTML = textarea.value || '';

            // Replace textarea with editor
            textarea.style.display = 'none';
            textarea.parentNode.insertBefore(editorContainer, textarea.nextSibling);
            editorContainer.appendChild(toolbar);
            editorContainer.appendChild(editorContent);

            // Update textarea value when editor content changes
            editorContent.addEventListener('input', () => {
                textarea.value = editorContent.innerHTML;
            });

            // Add toolbar button functionality
            const buttons = toolbar.querySelectorAll('.format-btn');
            buttons.forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    const command = button.dataset.command;
                    const value = button.dataset.value;

                    if (command === 'insertHTML' && value) {
                        this.insertHTMLAtCursor(editorContent, value);
                    } else {
                        document.execCommand(command, false, value);
                    }

                    editorContent.focus();
                });
            });

            // Handle tab key for better formatting
            editorContent.addEventListener('keydown', (e) => {
                if (e.key === 'Tab') {
                    e.preventDefault();
                    document.execCommand('insertHTML', false, '&nbsp;&nbsp;&nbsp;&nbsp;');
                }
            });
        }

        insertHTMLAtCursor(editor, html) {
            const selection = window.getSelection();
            if (selection.rangeCount) {
                const range = selection.getRangeAt(0);
                range.deleteContents();
                const div = document.createElement('div');
                div.innerHTML = html;
                const fragment = document.createDocumentFragment();
                let node;
                while ((node = div.firstChild)) {
                    fragment.appendChild(node);
                }
                range.insertNode(fragment);
            }
        }

        async initialize() {
            if (!token) {
                this.showError('Authentication required. Please login again.');
                return;
            }

            this.showLoading();
            try {
                await this.loadReviewData();
                await this.loadLatestTimelineEvent();
                this.hideLoading();
                this.showContent();
            } catch (error) {
                console.error('Error initializing:', error);
                this.showError(error.message || 'Failed to load review details. Please try again.');
            }
        }

        async loadReviewData() {
            try {
                const data = await apiFetch(`${BASE_URL}/reviews/${this.reviewId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });

                if (!data.success) {
                    throw new Error(data.message || 'Failed to load review data');
                }

                this.review = data.review;
                this.renderManuscriptHeader();
                this.renderFileInfo();
                this.renderAbstract();
                this.renderAuthors();
                await this.renderEditors();
                this.renderRevisions();
                this.updateDecisionSection();
                this.updateReviewFormVisibility();

            } catch (error) {
                console.error('Error loading review data:', error);
                throw error;
            }
        }

        async loadLatestTimelineEvent() {
            try {
                if (!this.review?.manuscript?.history) return;

                const history = this.review.manuscript.history || [];
                const latestEvent = history.length > 0 ? history[history.length - 1] : null;

                if (latestEvent) {
                    await this.renderLatestTimelineEvent(latestEvent);
                } else {
                    this.renderTimeline([]);
                }

            } catch (error) {
                console.error('Error loading timeline data:', error);
                this.renderTimeline([]);
            }
        }

        async renderLatestTimelineEvent(event) {
            const timelineContainer = document.getElementById('recentTimeline');
            if (!timelineContainer) return;

            let updatedBy = 'System';
            if (event.by) {
                const user = await this.getUserDetails(event.by);
                if (user) {
                    updatedBy = `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.email || 'Unknown User';
                }
            }

            const processedComment = this.processContentForDisplay(event.comment || 'No comment provided');
            const isCommentLong = processedComment.plainText.length > 150;
            const commentPreview = isCommentLong ?
                processedComment.plainText.substring(0, 150) + '...' :
                processedComment.plainText;
            const commentDisplayHtml = isCommentLong ?
                this.processContentForDisplay(commentPreview).displayHtml :
                processedComment.displayHtml;

            timelineContainer.innerHTML = `
                <div class="timeline-item">
                    <div class="card">
                        <span class="status-badge" style="${this.getStatusStyle(event.status)}">
                            ${this.formatStatus(event.status)}
                        </span>
                        <div class="timeline-comment">
                            ${commentDisplayHtml}
                            ${isCommentLong ? `
                                <a class="view-more-link" onclick="window.reviewDetails.showFullContent('${this.escapeHtml(processedComment.displayHtml)}', 'timeline-comment', 'Timeline Comment - ${this.formatStatus(event.status)}')">
                                    <i class="fas fa-eye"></i> View full comment
                                </a>
                            ` : ''}
                        </div>
                        <p class="timeline-date">
                            <i class="far fa-clock"></i> ${this.formatDate(event.date)}
                        </p>
                        <div class="updated-by">
                            <strong><i class="fas fa-user"></i> Updated by: ${this.escapeHtml(updatedBy)}</strong>
                        </div>
                    </div>
                </div>
            `;
        }

        renderRevisions() {
            const revisionsSection = document.getElementById('revisionsSection');
            const revisionsContainer = document.getElementById('revisionsContainer');
            const viewAllRevisionsBtn = document.getElementById('viewAllRevisionsBtn');

            if (!revisionsSection || !revisionsContainer || !this.review) return;

            const status = this.review.manuscript?.status || '';
            const revisions = this.review.manuscript?.revisions || [];

            if (status === 'submitted' || revisions.length === 0) {
                revisionsSection.style.display = 'none';
                return;
            }

            revisionsSection.style.display = 'block';

            if (viewAllRevisionsBtn && revisions.length > 0) {
                viewAllRevisionsBtn.style.display = 'inline-flex';
            }

            const latestRevision = revisions[0];

            if (!latestRevision) {
                revisionsContainer.innerHTML = `
                    <div class="no-revisions">
                        <i class="fas fa-history"></i>
                        <h3>No Revisions Available</h3>
                        <p>No revisions have been submitted for this manuscript.</p>
                    </div>
                `;
                return;
            }

            const version = latestRevision.version || 1;
            const coverLetter = latestRevision.coverLetter || '';
            const changesSummary = latestRevision.changesSummary || '';
            const submittedAt = this.formatDate(latestRevision.submittedAt || latestRevision.createdAt, true);
            const fileUrl = this.buildFileUrl(latestRevision.file?.url || latestRevision.file);
            const fileName = latestRevision.file?.originalName || `Revision_${version}.pdf`;

            // NEW: Use Office Online viewer for Word documents
            const viewUrl = this.getDocumentViewUrl(fileUrl);

            const processedCoverLetter = this.processContentForDisplay(coverLetter);
            const isCoverLetterLong = processedCoverLetter.plainText.length > 100;
            const coverLetterPreview = isCoverLetterLong ?
                processedCoverLetter.plainText.substring(0, 100) + '...' :
                processedCoverLetter.plainText;
            const coverLetterDisplayHtml = isCoverLetterLong ?
                this.processContentForDisplay(coverLetterPreview).displayHtml :
                processedCoverLetter.displayHtml;

            const processedChangesSummary = this.processContentForDisplay(changesSummary);
            const isChangesSummaryLong = processedChangesSummary.plainText.length > 100;
            const changesSummaryPreview = isChangesSummaryLong ?
                processedChangesSummary.plainText.substring(0, 100) + '...' :
                processedChangesSummary.plainText;
            const changesSummaryDisplayHtml = isChangesSummaryLong ?
                this.processContentForDisplay(changesSummaryPreview).displayHtml :
                processedChangesSummary.displayHtml;

            let revisionsHTML = '<div class="revisions-grid">';
            revisionsHTML += `
                <div class="revision-card">
                    <div class="revision-header">
                        <div class="revision-title">
                            <i class="fas fa-file-edit"></i> Latest Revision
                        </div>
                        <span class="revision-version">v${version}</span>
                    </div>
                    
                    <div class="revision-content">
                        ${coverLetter ? `
                        <div class="revision-item">
                            <div class="revision-label">
                                <i class="fas fa-envelope"></i> Cover Letter
                            </div>
                            <div class="revision-text ${isCoverLetterLong ? 'truncated' : ''}">
                                ${coverLetterDisplayHtml}
                            </div>
                            ${isCoverLetterLong ? `
                                <a class="view-more-link" onclick="window.reviewDetails.showFullContent('${this.encodeForModal(processedCoverLetter.displayHtml)}', 'cover-letter', 'Cover Letter - Revision ${version}')">
                                    <i class="fas fa-eye"></i> View full cover letter
                                </a>
                            ` : ''}
                        </div>
                        ` : ''}
                        
                        ${changesSummary ? `
                        <div class="revision-item">
                            <div class="revision-label">
                                <i class="fas fa-list-check"></i> Changes Summary
                            </div>
                            <div class="revision-text ${isChangesSummaryLong ? 'truncated' : ''}">
                                ${changesSummaryDisplayHtml}
                            </div>
                            ${isChangesSummaryLong ? `
                                <a class="view-more-link" onclick="window.reviewDetails.showFullContent('${this.encodeForModal(processedChangesSummary.displayHtml)}', 'changes-summary', 'Changes Summary - Revision ${version}')">
                                    <i class="fas fa-eye"></i> View full changes summary
                                </a>
                            ` : ''}
                        </div>
                        ` : ''}
                        
                        <div class="revision-meta">
                            <div class="revision-date">
                                <i class="far fa-calendar"></i> Submitted on: ${submittedAt}
                            </div>
                            ${viewUrl ? `
                                <a href="${viewUrl}" target="_blank" class="view-document-btn">
                                    <i class="fas fa-file-pdf"></i> View Document
                                </a>
                            ` : '<span class="score-empty">No document</span>'}
                        </div>
                    </div>
                </div>
            `;
            revisionsHTML += '</div>';
            revisionsContainer.innerHTML = revisionsHTML;
        }

        buildFileUrl(filePath) {
            if (!filePath) return null;

            const baseUrl = BASE_URL.replace('/api/v1', '');

            try {
                const url = new URL(filePath);
                return url.toString();
            } catch {
                const normalizedPath = filePath.startsWith('/') ? filePath : `/${filePath}`;
                return `${baseUrl}${normalizedPath}`;
            }
        }

        // NEW: Get document view URL with Office Online viewer for Word documents
        getDocumentViewUrl(fileUrl) {
            if (!fileUrl) return null;

            const url = fileUrl.toLowerCase();
            const isOfficeDoc = url.endsWith(".docx") || url.endsWith(".doc");

            if (isOfficeDoc) {
                return `https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(fileUrl)}`;
            }

            return fileUrl;
        }

        updateReviewFormVisibility() {
            const reviewFormSection = document.getElementById('reviewFormSection');
            const reviewSubmittedMessage = document.getElementById('reviewSubmittedMessage');
            const decisionSection = document.querySelector('.decision-section');

            if (!this.review) return;

            const invitationStatus = this.review.invitationStatus;
            const manuscriptStatus = this.review.manuscript?.status;

            reviewFormSection.style.display = 'none';
            reviewSubmittedMessage.style.display = 'none';

            if (invitationStatus === 'accepted' && manuscriptStatus === 'under_review') {
                reviewFormSection.style.display = 'block';
                decisionSection.style.display = 'none';
            } else if (invitationStatus === 'accepted' && this.review.submittedAt) {
                reviewSubmittedMessage.style.display = 'block';
                decisionSection.style.display = 'none';
            } else {
                decisionSection.style.display = 'block';
                reviewFormSection.style.display = 'none';
                reviewSubmittedMessage.style.display = 'none';
            }
        }

        renderManuscriptHeader() {
            const header = document.getElementById('manuscriptHeader');
            if (!header || !this.review) return;

            const manuscript = this.review.manuscript;
            const formattedDate = this.formatDate(manuscript.createdAt);
            const statusDisplay = this.formatStatus(manuscript.status);
            const scopeTitle = manuscript.scope?.title || 'No Scope Assigned';

            header.innerHTML = `
                <h1>${this.escapeHtml(manuscript.title)}</h1>
                <span class="header-status-badge" style="${this.getStatusStyle(manuscript.status)}">
                    ${statusDisplay}
                </span>
                <div class="header-meta">
                    <div class="meta-item">
                        <i class="fas fa-tags"></i>
                        <span>Scope: ${this.escapeHtml(scopeTitle)}</span>
                    </div>
                    <div class="meta-item">
                        <i class="far fa-calendar"></i>
                        <span>Submitted on: ${formattedDate}</span>
                    </div>
                </div>
            `;
        }

        getStatusStyle(status) {
            const style = getComputedStyle(document.documentElement);

            const colorMap = {
                'submitted': style.getPropertyValue('--status-submitted') || '#3b82f6',
                'under_review': style.getPropertyValue('--status-under-review') || '#f59e0b',
                'reviewed': style.getPropertyValue('--status-reviewed') || '#10b981',
                'accepted': style.getPropertyValue('--status-accepted') || '#10b981',
                'rejected': style.getPropertyValue('--status-rejected') || '#ef4444',
                'revised': style.getPropertyValue('--status-revised') || '#8b5cf6',
                'awaiting_payment': style.getPropertyValue('--status-awaiting-payment') || '#f59e0b',
                'published': style.getPropertyValue('--status-published') || '#06b6d4',
                'accept': style.getPropertyValue('--status-accept') || '#10b981',
                'reject': style.getPropertyValue('--status-reject') || '#ef4444',
                'minor_revision': style.getPropertyValue('--status-minor-revision') || '#f59e0b',
                'major_revision': style.getPropertyValue('--status-major-revision') || '#f97316',
                'revision_requested': style.getPropertyValue('--status-revision-requested') || '#8b5cf6'
            };

            const color = colorMap[status] || style.getPropertyValue('--muted') || '#6b7280';
            return `background-color: ${color}; color: white;`;
        }

        renderFileInfo() {
            const fileInfoCard = document.getElementById('fileInfoCard');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const viewDocumentLink = document.getElementById('viewDocumentLink');

            if (!this.review?.manuscript?.file) return;

            const file = this.review.manuscript.file;
            const fileUrl = this.buildFileUrl(file.url);
            // NEW: Use Office Online viewer for Word documents
            const viewUrl = this.getDocumentViewUrl(fileUrl);
            const originalName = file.originalName || 'Unknown file';

            fileName.textContent = originalName;
            fileSize.textContent = `Original file: ${originalName}`;
            viewDocumentLink.href = viewUrl; // Use the view URL instead of direct file URL
            viewDocumentLink.target = '_blank';
        }

        downloadDocument() {
            if (!this.review?.manuscript?.file) {
                toastr.error('No document available to download', 'Error');
                return;
            }

            const file = this.review.manuscript.file;
            const fileUrl = this.buildFileUrl(file.url);
            const fileName = file.originalName || 'document.pdf';

            const link = document.createElement('a');
            link.href = fileUrl;
            link.download = fileName;
            link.target = '_blank';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        renderAbstract() {
            const abstractContent = document.getElementById('abstractContent');
            if (!abstractContent || !this.review) return;

            const abstract = this.review.manuscript.abstract || 'No abstract provided.';

            if (abstract && abstract.trim() !== '') {
                const processedAbstract = this.processContentForDisplay(abstract);
                const isAbstractLong = processedAbstract.plainText.length > 300;
                const abstractPreview = isAbstractLong ?
                    processedAbstract.plainText.substring(0, 300) + '...' :
                    processedAbstract.plainText;
                const abstractDisplayHtml = isAbstractLong ?
                    this.processContentForDisplay(abstractPreview).displayHtml :
                    processedAbstract.displayHtml;

                abstractContent.innerHTML = `
                    <div class="abstract-text ${isAbstractLong ? 'truncated' : ''}">
                        ${abstractDisplayHtml}
                    </div>
                    ${isAbstractLong ? `
                        <a class="view-more-link" onclick="window.reviewDetails.showFullContent('${this.encodeForModal(processedAbstract.displayHtml)}', 'abstract', 'Abstract')">
                            <i class="fas fa-eye"></i> View full abstract
                        </a>
                    ` : ''}
                `;
            } else {
                abstractContent.innerHTML = '<span style="color: #9ca3af;">No abstract provided.</span>';
            }
        }

        renderAuthors() {
            const authorsList = document.getElementById('authorsList');
            const authorsCount = document.getElementById('authorsCount');
            if (!authorsList || !this.review) return;

            const authors = this.review.manuscript.authors || [];
            authorsCount.textContent = authors.length;

            if (authors.length === 0) {
                authorsList.innerHTML = '<div class="no-authors">No authors listed</div>';
                return;
            }

            authorsList.innerHTML = authors.map(author => `
                <div class="author-item">
                    <div class="author-name">${this.escapeHtml(author.name)}</div>
                    <div class="author-email">
                        <i class="fas fa-envelope"></i>
                        ${this.escapeHtml(author.email)}
                    </div>
                </div>
            `).join('');
        }

        async renderEditors() {
            const editorsList = document.getElementById('editorsList');
            const editorsCount = document.getElementById('editorsCount');

            if (!editorsList || !this.review) return;

            const scope = this.review.manuscript.scope;
            if (!scope) {
                editorsList.innerHTML = '<div class="no-editors">No scope assigned</div>';
                editorsCount.textContent = '0';
                return;
            }

            const editorsInChiefIds = scope.editorsInChief || [];
            const associateEditorsIds = scope.associateEditors || [];
            const totalEditors = editorsInChiefIds.length + associateEditorsIds.length;

            editorsCount.textContent = totalEditors;

            if (totalEditors === 0) {
                editorsList.innerHTML = '<div class="no-editors">No editors assigned to this scope</div>';
                return;
            }

            const editorsInChief = await Promise.all(
                editorsInChiefIds.map(id => this.getUserDetails(id))
            );

            const associateEditors = await Promise.all(
                associateEditorsIds.map(id => this.getUserDetails(id))
            );

            let html = '<div class="editors-list">';

            if (editorsInChief.length > 0) {
                html += `
                    <div class="editor-category"><h4> Editor-in-Chief</h4>
                        ${editorsInChief.map(editor => editor ? this.renderEditorItem(editor, 'Editor-in-Chief') : '').join('')}
                    </div>
                `;
            }

            if (associateEditors.length > 0) {
                html += `
                    <div class="editor-category">
                        <h4> Associate Editors</h4>
                        ${associateEditors.map(editor => editor ? this.renderEditorItem(editor, 'Associate Editor') : '').join('')}
                    </div>
                `;
            }

            html += '</div>';
            editorsList.innerHTML = html;
        }

        renderEditorItem(user, role) {
            const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim() || 'Unnamed Editor';
            return `
                <div class="editor-item">
                    <div class="editor-name"> ${this.escapeHtml(fullName)}
                    </div>
                    <div class="editor-email">
                        <i class="fas fa-envelope"></i> ${this.escapeHtml(user.email || 'No email')}
                    </div>
                    <div class="editor-role">${role}</div>
                </div>
            `;
        }

        async getUserDetails(userId) {
            if (this.userCache.has(userId)) {
                return this.userCache.get(userId);
            }

            try {
                if (!userId) return null;

                const data = await apiFetch(`${BASE_URL}/user/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });

                if (!data.success) {
                    console.warn(`Failed to fetch user ${userId}:`, data.message);
                    return null;
                }

                const user = data.user;
                this.userCache.set(userId, user);
                return user;

            } catch (error) {
                console.error(`Error fetching user ${userId}:`, error);
                return null;
            }
        }

        updateDecisionSection() {
            const decisionStatusBadge = document.getElementById('decisionStatusBadge');
            const decisionButtons = document.getElementById('decisionButtons');
            const decisionMessage = document.getElementById('decisionMessage');

            if (!this.review) return;

            const invitationStatus = this.review.invitationStatus;

            decisionStatusBadge.className = `decision-status-badge ${invitationStatus}`;
            const statusIcon = invitationStatus === 'accepted' ? 'fa-check-circle' :
                invitationStatus === 'declined' ? 'fa-times-circle' : 'fa-clock';
            const statusText = invitationStatus === 'accepted' ? 'Review Accepted' :
                invitationStatus === 'declined' ? 'Review Declined' : 'Pending Your Response';

            decisionStatusBadge.innerHTML = `
                <i class="fas ${statusIcon}"></i>
                <span>${statusText}</span>
            `;

            if (invitationStatus === 'pending') {
                decisionButtons.style.display = 'flex';
                decisionMessage.innerHTML = 'Please accept or decline this review invitation.';
            } else {
                decisionButtons.style.display = 'none';
                if (invitationStatus === 'accepted') {
                    decisionMessage.innerHTML = `
                        <i class="fas fa-check-circle" style="color: var(--success);"></i>
                        You have accepted this review invitation.
                    `;
                } else if (invitationStatus === 'declined') {
                    decisionMessage.innerHTML = `
                        <i class="fas fa-times-circle" style="color: var(--danger);"></i>
                        You have declined this review invitation.
                    `;
                }
            }

            const acceptBtn = document.getElementById('acceptBtn');
            const declineBtn = document.getElementById('declineBtn');
            if (invitationStatus !== 'pending') {
                acceptBtn.disabled = true;
                declineBtn.disabled = true;
            }
        }

        async respondToInvitation(decision) {
            try {
                if (!token) {
                    toastr.error('Authentication required. Please login again.', 'Error');
                    return;
                }

                const requestBody = {
                    reviewId: this.reviewId,
                    decision: decision
                };

                const acceptBtn = document.getElementById('acceptBtn');
                const declineBtn = document.getElementById('declineBtn');

                if (decision === 'accept') {
                    acceptBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Accepting...';
                } else {
                    declineBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Declining...';
                }

                acceptBtn.disabled = true;
                declineBtn.disabled = true;

                const data = await apiFetch(`${BASE_URL}/reviews/respond`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!data.success) {
                    throw new Error(data.message || `Failed to ${decision} review`);
                }

                toastr.success(`Successfully ${decision}ed the review invitation`, 'Success');
                this.review.invitationStatus = decision;
                await this.loadReviewData();
                this.updateDecisionSection();
                this.updateReviewFormVisibility();

            } catch (error) {
                console.error('Error responding to invitation:', error);
                toastr.error(error.message || 'Failed to respond to invitation', 'Error');

                const acceptBtn = document.getElementById('acceptBtn');
                const declineBtn = document.getElementById('declineBtn');
                acceptBtn.innerHTML = '<i class="fas fa-check-circle"></i> Accept Review';
                declineBtn.innerHTML = '<i class="fas fa-times-circle"></i> Decline Review';

                if (this.review?.invitationStatus === 'pending') {
                    acceptBtn.disabled = false;
                    declineBtn.disabled = false;
                }
            }
        }

        handleFileSelect(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            const file = files[0];

            const allowedTypes = ['application/pdf', 'application/msword',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];

            if (!allowedTypes.includes(file.type)) {
                toastr.error('Please upload only PDF or Word documents', 'Invalid File Type');
                return;
            }

            const maxSize = 10 * 1024 * 1024;
            if (file.size > maxSize) {
                toastr.error('File size must be less than 10MB', 'File Too Large');
                return;
            }

            this.selectedFile = file;
            this.updateFilePreview();
        }

        updateFilePreview() {
            const filePreview = document.getElementById('filePreview');
            const fileName = document.getElementById('fileNamePreview');
            const fileSize = document.getElementById('fileSizePreview');

            if (!this.selectedFile) {
                filePreview.classList.remove('show');
                return;
            }

            const sizeInMB = (this.selectedFile.size / (1024 * 1024)).toFixed(2);

            fileName.textContent = this.selectedFile.name;
            fileSize.textContent = `${sizeInMB} MB`;

            filePreview.classList.add('show');
        }

        removeSelectedFile() {
            this.selectedFile = null;
            document.getElementById('reviewFile').value = '';
            document.getElementById('filePreview').classList.remove('show');
        }

        async submitReview() {
            try {
                const formData = {
                    reviewId: this.reviewId,
                    commentsToEditor: document.getElementById('commentsToEditor').value.trim(),
                    commentsToAuthor: document.getElementById('commentsToAuthor').value.trim(),
                    recommendation: document.querySelector('input[name="recommendation"]:checked')?.value,
                    score: parseInt(document.getElementById('score').value)
                };

                // NEW: Enhanced validation
                let isValid = true;
                let errorMessage = '';

                // Convert HTML to plain text for validation
                const stripHtml = (html) => {
                    const tmp = document.createElement('div');
                    tmp.innerHTML = html;
                    return tmp.textContent || tmp.innerText || '';
                };

                const editorCommentPlain = stripHtml(formData.commentsToEditor).trim();
                const authorCommentPlain = stripHtml(formData.commentsToAuthor).trim();

                // Validate comments to editor
                if (!editorCommentPlain) {
                    isValid = false;
                    errorMessage = 'Please provide comments to the editor';
                }
                // Validate comments to author
                else if (!authorCommentPlain) {
                    isValid = false;
                    errorMessage = 'Please provide comments to the author';
                }
                // Validate recommendation
                else if (!formData.recommendation) {
                    isValid = false;
                    errorMessage = 'Please select a recommendation';
                }
                // Validate score (should be between 0-100)
                else if (isNaN(formData.score) || formData.score < 0 || formData.score > 100) {
                    isValid = false;
                    errorMessage = 'Please provide a valid score between 0-100';
                }

                if (!isValid) {
                    toastr.error(errorMessage, 'Please fill out the review form');
                    return;
                }

                const submitBtn = document.getElementById('submitReviewBtn');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
                submitBtn.disabled = true;

                let response;

                if (this.selectedFile) {
                    const formDataObj = new FormData();
                    formDataObj.append('reviewId', formData.reviewId);
                    formDataObj.append('commentsToEditor', formData.commentsToEditor);
                    formDataObj.append('commentsToAuthor', formData.commentsToAuthor);
                    formDataObj.append('recommendation', formData.recommendation);
                    formDataObj.append('score', formData.score.toString());
                    formDataObj.append('reviewFile', this.selectedFile);

                    response = await fetch(`${BASE_URL}/reviews/submit`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formDataObj
                    });
                } else {
                    response = await fetch(`${BASE_URL}/reviews/submit`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                }

                const responseData = await response.json();

                if (!responseData.success) {
                    throw new Error(responseData.message || 'Failed to submit review');
                }

                Swal.fire({
                    title: 'Review Submitted Successfully!',
                    text: 'Thank you for your review. The editor has been notified.',
                    icon: 'success',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#10b981',
                    timer: 3000,
                    timerProgressBar: true
                }).then(async () => {
                    await this.loadReviewData();
                });

            } catch (error) {
                console.error('Error submitting review:', error);
                toastr.error(error.message || 'Failed to submit review', 'Error');
            } finally {
                const submitBtn = document.getElementById('submitReviewBtn');
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Review';
                submitBtn.disabled = false;
            }
        }

        resetForm() {
            const form = document.getElementById('reviewForm');
            if (form) {
                form.reset();
                document.getElementById('scoreDisplay').textContent = '50';
                document.getElementById('score').value = '50';
                this.removeSelectedFile();

                // Reset rich text editors
                const editorContents = document.querySelectorAll('.editor-content');
                editorContents.forEach(editor => {
                    editor.innerHTML = '';
                });

                const textareas = document.querySelectorAll('textarea');
                textareas.forEach(textarea => {
                    textarea.value = '';
                });
            }
        }

        // Content display methods
        processContentForDisplay(content) {
            if (!content || content.trim() === '') {
                return {
                    plainText: '',
                    displayHtml: '<span style="color: #9ca3af;">No content provided.</span>'
                };
            }

            const sanitizedHtml = this.sanitizeHTML(content);
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = sanitizedHtml;
            const plainText = tempDiv.textContent || tempDiv.innerText || '';

            return {
                plainText: plainText,
                displayHtml: sanitizedHtml
            };
        }

        sanitizeHTML(html) {
            if (!html) return '';

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;

            const scripts = tempDiv.querySelectorAll('script, style, link, meta, object, embed, iframe, frame');
            scripts.forEach(script => script.remove());

            const allowedTags = ['p', 'br', 'strong', 'b', 'em', 'i', 'u', 'ul', 'ol', 'li', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6'];

            const allElements = tempDiv.querySelectorAll('*');
            allElements.forEach(el => {
                if (!allowedTags.includes(el.tagName.toLowerCase())) {
                    const text = document.createTextNode(el.textContent);
                    el.parentNode.replaceChild(text, el);
                }
            });

            return tempDiv.innerHTML.trim() || html;
        }

        encodeForModal(content) {
            return String(content)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;')
                .replaceAll('\n', ' ')
                .replaceAll('\r', '');
        }

        showFullContent(contentHtml, contentType, title) {
            this.currentModalContent = contentHtml;
            this.currentModalType = contentType;
            this.currentModalTitle = title;

            const modal = document.getElementById('contentModal');
            const modalTitle = document.getElementById('contentModalTitle');
            const modalType = document.getElementById('contentModalType');
            const contentDisplay = document.getElementById('contentDisplay');

            if (!modal || !modalTitle || !modalType || !contentDisplay) return;

            modalTitle.textContent = title;

            const typeMap = {
                'cover-letter': 'Cover Letter',
                'changes-summary': 'Changes Summary',
                'abstract': 'Abstract',
                'timeline-comment': 'Timeline Comment'
            };

            modalType.textContent = typeMap[contentType] || 'Content';

            contentDisplay.innerHTML = `
                <div class="content-display">
                    ${contentHtml || '<div class="empty">No content available</div>'}
                </div>
            `;

            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        closeContentModal() {
            const modal = document.getElementById('contentModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
                this.currentModalContent = '';
                this.currentModalType = '';
                this.currentModalTitle = '';
            }
        }

        formatStatus(status) {
            const statusMap = {
                'submitted': 'Submitted',
                'under_review': 'Under Review',
                'reviewed': 'Reviewed',
                'accepted': 'Accepted',
                'rejected': 'Rejected',
                'revised': 'Revised',
                'awaiting_payment': 'Awaiting Payment',
                'published': 'Published',
                'minor_revision': 'Minor Revision',
                'major_revision': 'Major Revision',
                'revision_requested': 'Revision Requested'
            };
            return statusMap[status] || (status.charAt(0).toUpperCase() + status.slice(1)).replace(/_/g, ' ');
        }

        formatDate(dateString, dateOnly = false) {
            try {
                if (!dateString) return '';
                const date = new Date(dateString);
                if (dateOnly) {
                    return date.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                }
                return date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit'
                });
            } catch (error) {
                return dateString;
            }
        }

        showLoading() {
            document.getElementById('loadingScreen').style.display = 'block';
            document.getElementById('errorScreen').style.display = 'none';
            document.getElementById('contentContainer').style.display = 'none';
        }

        hideLoading() {
            document.getElementById('loadingScreen').style.display = 'none';
        }

        showContent() {
            document.getElementById('contentContainer').style.display = 'block';
        }

        showError(message) {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('errorScreen').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }

        escapeHtml(str) {
            if (!str && str !== 0) return '';
            return String(str)
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        renderTimeline(events) {
            const timelineContainer = document.getElementById('recentTimeline');
            if (!timelineContainer) return;

            if (events.length === 0) {
                timelineContainer.innerHTML = '<div style="color: var(--muted); text-align: center; padding: 2rem;">No timeline events found</div>';
            }
        }
    }

    // Initialize after DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        window.reviewDetails = new ReviewDetailsManager();
    });
</script>
</body>

</html>